<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PixelUp SuperApp — Index V6</title>
  <meta name="description" content="SuperApp: Home, CRM + WhatsApp, Mentoria (8 módulos), Bootcamp Chat (IA)"/>
  <meta name="theme-color" content="#0b1a2a"/>
  <link rel="preconnect" href="https://generativelanguage.googleapis.com" crossorigin>
  <style>
    :root{ --bg:#0b1118; --panel:#0f1b2a; --muted:#9bb3c7; --primary:#12b0ff; --primary2:#66d1ff; --accent:#00ffd5;
           --danger:#ff5d5d; --ok:#27c93f; --card:#0e1825; --border:#122235; --radius:16px; --shadow:0 8px 28px rgba(0,0,0,.35); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1000px 600px at 10% -10%, rgba(18,176,255,.14), transparent 60%),
                 radial-gradient(800px 500px at 110% 10%, rgba(0,255,213,.10), transparent 60%), var(--bg);
      color:#eaf6ff;}
    a{color:var(--primary)} small.muted, .muted{color:#9bb3c7}
    header.topbar{position:sticky;top:0;z-index:20;display:flex;gap:16px;align-items:center;justify-content:space-between;
      padding:14px 18px;background:rgba(11,20,32,.8);border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));
      box-shadow:0 0 12px rgba(18,176,255,.7),0 0 24px rgba(0,255,213,.5)}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    nav.tabs button{background:#0b1522;color:#cfeaff;border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer}
    nav.tabs button.active{border-color:var(--primary);color:#fff;box-shadow:0 0 0 1px rgba(18,176,255,.25) inset}
    main{max-width:1200px;margin:24px auto;padding:0 16px}
    section.panel{display:none;background:rgba(15,27,42,.6);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:18px}
    section.panel.active{display:block}
    .grid{display:grid;gap:16px}
    .g-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#001726;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 10px 22px rgba(0,0,0,.35),0 2px 0 rgba(0,0,0,.2) inset}
    .btn.secondary{background:#0b1522;color:#dff2ff;border:1px solid var(--border);box-shadow:none}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0c1725;color:#eaf6ff}
    .ws-dot{width:10px;height:10px;border-radius:50%;background:#666}.ws-dot.on{background:var(--ok)}.ws-dot.off{background:var(--danger)}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
    .list{overflow:auto;max-height:60vh}
    .thread{overflow:auto;max-height:60vh;padding:12px;background:#0b1522;border-radius:12px;border:1px solid var(--border)}
    .msg{margin:8px 0;padding:8px 10px;border-radius:10px;border:1px solid var(--border)} .msg.me{background:#062438} .msg.them{background:#112234}
    footer{color:#7fa6c2;text-align:center;padding:28px 12px}
    @media (max-width:900px){ .g-3,.g-2{grid-template-columns:1fr} }
    .tiny{font-size:12px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><span class="dot"></span> PixelUp SuperApp</div>
    <nav class="tabs" id="tabs">
      <button data-tab="home" class="active">Home</button>
      <button data-tab="crm">CRM + Chat</button>
      <button data-tab="mentoria">Mentoria (8 módulos)</button>
      <button data-tab="bootcamp">Chat do Bootcamp</button>
    </nav>
    <div class="row">
      <span class="ws-dot off" id="waDot"></span><span id="waLabel" class="muted">WA: off</span>
      <span class="pill" id="sseBadge">SSE: —</span>
      <span class="pill" id="botBadge">Bot: OFF</span>
      <button class="btn secondary" id="toggleBot">Ligar Bot</button>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section class="panel active" id="panel-home">
      <div class="grid g-3">
        <div class="card">
          <h2>Hub — Chat-First</h2>
          <p class="muted">WhatsApp conectado, CRM automático e IA (Gemini). Quando o <b>Bot</b> está ligado, ele responde; desligue para atendimento humano.</p>
          <div class="row">
            <button class="btn" data-goto="crm">Abrir CRM</button>
            <button class="btn secondary" data-goto="mentoria">Mentoria</button>
            <button class="btn secondary" data-goto="bootcamp">Bootcamp</button>
          </div>
        </div>
        <div class="card">
          <h3>Configurações</h3>
          <div class="row">
            <input class="input" id="myNumber" placeholder="Seu número WA (55DDDNUMERO)">
            <button class="btn secondary" id="saveNumber">Salvar</button>
          </div>
          <small class="muted">Evita o bot responder seu próprio número.</small>
          <div style="margin-top:12px">
            <label class="muted" for="aiKey">Gemini API Key</label>
            <input class="input" id="aiKey" placeholder="Cole sua chave do Gemini">
            <button class="btn secondary" id="saveKey" style="margin-top:8px">Salvar Key</button>
            <small class="muted">Ou use <code>?gemini=SUA_KEY</code> na URL. Se não preencher, o app tenta usar <code>/api/gemini</code> no backend.</small>
            <div class="tiny muted" id="keyStatus">Key: —</div>
          </div>
        </div>
        <div class="card">
          <h3>Status do WhatsApp</h3>
          <div class="row">
            <span class="pill" id="waStatusText">off</span>
            <button class="btn secondary" id="btnCheckWA">Verificar</button>
          </div>
          <p class="muted">Conexão via <code>/api/*</code> (proxy Vercel → Replit).</p>
        </div>
        <div class="card">
          <h3>Diagnóstico</h3>
          <div id="diag"></div>
        </div>
      </div>
    </section>

    <!-- CRM + CHAT -->
    <section class="panel" id="panel-crm">
      <div class="grid g-2">
        <div class="card">
          <h3>Contatos</h3>
          <div class="row">
            <input class="input" id="search" placeholder="Buscar por nome/telefone">
            <button class="btn secondary" id="clearSearch">Limpar</button>
          </div>
          <div class="list" id="contactsList"></div>
          <div class="card" style="margin-top:12px">
            <h4>Novo contato</h4>
            <input class="input" id="cName" placeholder="Nome (opcional)">
            <input class="input" id="cPhone" placeholder="Telefone (WhatsApp)">
            <textarea class="input" id="cNotes" placeholder="Notas"></textarea>
            <button class="btn" id="btnAdd">Adicionar</button>
          </div>
        </div>
        <div class="card">
          <h3 id="threadTitle">Conversa</h3>
          <div class="thread" id="thread"></div>
          <div class="row" style="margin-top:8px">
            <input class="input" id="msgText" placeholder="Escreva uma mensagem">
            <button class="btn" id="sendMsg">Enviar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- MENTORIA -->
    <section class="panel" id="panel-mentoria">
      <div class="grid g-2">
        <div class="card">
          <h3>Módulos</h3>
          <div id="modulesList"></div>
        </div>
        <div class="card">
          <h3 id="lessonTitle">Selecione um módulo</h3>
          <div id="lessonBody" class="muted">O conteúdo aparecerá aqui.</div>
        </div>
      </div>
    </section>

    <!-- BOOTCAMP -->
    <section class="panel" id="panel-bootcamp">
      <div class="grid g-2">
        <div class="card">
          <h3>Chat do Bootcamp (IA)</h3>
          <p class="muted">Tira-dúvidas com o Gemini (não envia ao WhatsApp).</p>
          <textarea class="input" id="bootQ" rows="4" placeholder="Digite sua dúvida..."></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="bootAsk">Perguntar</button>
          </div>
        </div>
        <div class="card">
          <h3>Resposta</h3>
          <div id="bootA" class="thread"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Mentoria (8) inline -->
  <script id="mentoria-data" type="application/json">{
    "modules":[
      {"id":"m1","title":"Módulo 1 — Persona e Fundamentos do Negócio","lessons":[
        {"id":"m1l1","title":"Definição de Persona","content":"# Persona\nDescreva claramente seu cliente ideal.\n- Dor principal\n- Desejos e objeções\n- Linguagem e canais preferidos"},
        {"id":"m1l2","title":"Proposta de Valor","content":"**O que torna sua oferta única?** Liste benefícios tangíveis e intangíveis."}
      ]},
      {"id":"m2","title":"Módulo 2 — Algoritmo do Meta (Facebook/Instagram)","lessons":[
        {"id":"m2l1","title":"Como o algoritmo decide a entrega","content":"Sinais: engajamento, retenção, tempo de sessão, relevância."},
        {"id":"m2l2","title":"Boas práticas de conteúdo","content":"- Gatilhos de parada\n- CTAs claros\n- Testes A/B"}
      ]},
      {"id":"m3","title":"Módulo 3 — Cronograma e Calendário Editorial","lessons":[
        {"id":"m3l1","title":"Estrutura de calendário","content":"Organize posts por tema, formato e objetivo."},
        {"id":"m3l2","title":"Métricas de consistência","content":"Taxa de publicação, frequência mínima, cadência."}
      ]},
      {"id":"m4","title":"Módulo 4 — Conteúdo Visual (vídeo e imagem)","lessons":[
        {"id":"m4l1","title":"Roteiro e captação","content":"Storyboard, **hook** em 3s, cortes dinâmicos."},
        {"id":"m4l2","title":"Design que converte","content":"Contraste, tipografia, hierarquia e *branding*."}
      ]},
      {"id":"m5","title":"Módulo 5 — Copy com IA (ChatGPT)","lessons":[
        {"id":"m5l1","title":"Prompt base","content":"Estrutura com objetivo, público, tom e formato."},
        {"id":"m5l2","title":"Ajustes finos","content":"Refine com exemplos e *few-shot*."}
      ]},
      {"id":"m6","title":"Módulo 6 — CRM e Organização Comercial","lessons":[
        {"id":"m6l1","title":"Pipeline simples","content":"Kanban: Lead → Qualificando → Proposta → Fechou."},
        {"id":"m6l2","title":"Follow-up e rotinas","content":"Sequências e lembretes."}
      ]},
      {"id":"m7","title":"Módulo 7 — Técnicas de Vendas (rapport e conexão)","lessons":[
        {"id":"m7l1","title":"Rapport prático","content":"*Espelhamento*, *escuta ativa*, perguntas abertas."},
        {"id":"m7l2","title":"Fechamento","content":"Tratamento de objeções e *closing* sem pressão."}
      ]},
      {"id":"m8","title":"Módulo 8 — Implementação de CRM + Tráfego Pago","lessons":[
        {"id":"m8l1","title":"Integração com WhatsApp","content":"Conectar bot, gatilhos automáticos, registrar interações."},
        {"id":"m8l2","title":"Playbook de campanhas","content":"Estruturas por objetivo e orçamento inicial."}
      ]}
    ]
  }</script>

  <script>
  // ===== Config =====
  window.PIXELUP = {
    WA_BASE: "/api",   // proxy no vercel.json
    GEMINI_MODEL: "gemini-2.0-flash",
    REPLIT_DIRECT: "https://pixelup-wa-server.pixelupmrkt.repl.co" // para diagnóstico
  };
  // ===== Utils =====
  const $ = sel => document.querySelector(sel);
  const byId = id => document.getElementById(id);
  const escapeHtml = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
  const normPhone = p => (''+(p||'')).replace(/[^0-9]/g,'');
  const ls = { get(k, d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)); } };
  const qparam = (name)=> new URLSearchParams(location.search).get(name);

  // ===== Tabs =====
  (function initTabs(){
    const tabs = byId('tabs');
    const panels = { home: byId('panel-home'), crm: byId('panel-crm'), mentoria: byId('panel-mentoria'), bootcamp: byId('panel-bootcamp') };
    tabs.addEventListener('click', (e)=>{
      if(e.target.tagName==='BUTTON'){
        const tab = e.target.dataset.tab;
        tabs.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.tab===tab));
        Object.keys(panels).forEach(k => panels[k].classList.toggle('active', k===tab));
      }
    });
    document.querySelectorAll('[data-goto]').forEach(btn => btn.addEventListener('click', ()=>{
      const tab = btn.dataset.goto;
      tabs.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.tab===tab));
      Object.values(panels).forEach(p => p.classList.remove('active'));
      panels[tab].classList.add('active');
    }));
  })();

  // ===== State =====
  const state = {
    botOn: ls.get('px_bot_on', true),
    myNumber: ls.get('px_my_number', ''),
    aiKey: ls.get('px_ai_key', qparam('gemini') || ''),
    contacts: ls.get('px_contacts', {}),
    threads:  ls.get('px_threads', {}),
    current: null,
    search: ''
  };

  // ===== UI Refs =====
  const waDot = byId('waDot'), waLabel = byId('waLabel'), waStatusText = byId('waStatusText'), sseBadge = byId('sseBadge');
  const botBadge = byId('botBadge'), toggleBot = byId('toggleBot');
  const myNumber = byId('myNumber'), saveNumber = byId('saveNumber');
  const aiKey = byId('aiKey'), saveKey = byId('saveKey');
  const btnCheckWA = byId('btnCheckWA');
  const contactsList = byId('contactsList');
  const cName = byId('cName'), cPhone = byId('cPhone'), cNotes = byId('cNotes'), btnAdd = byId('btnAdd');
  const thread = byId('thread'), threadTitle = byId('threadTitle');
  const msgText = byId('msgText'), sendMsg = byId('sendMsg');
  const search = byId('search'), clearSearch = byId('clearSearch');
  const bootQ = byId('bootQ'), bootA = byId('bootA'), bootAsk = byId('bootAsk');
  const diag = byId('diag'), keyStatus = byId('keyStatus');

  // ===== Init UI =====
  (function initUI(){
    renderKeyStatus();
    botBadge.textContent = 'Bot: ' + (state.botOn? 'ON' : 'OFF');
    toggleBot.textContent = state.botOn ? 'Desligar Bot' : 'Ligar Bot';
    myNumber.value = state.myNumber || '';
    aiKey.value = state.aiKey || '';
    if(waStatusText) waStatusText.textContent = 'off';
    runDiagnostics();
  })();

  toggleBot.addEventListener('click', ()=>{
    state.botOn = !state.botOn; ls.set('px_bot_on', state.botOn);
    botBadge.textContent = 'Bot: ' + (state.botOn? 'ON' : 'OFF');
    toggleBot.textContent = state.botOn ? 'Desligar Bot' : 'Ligar Bot';
  });
  saveNumber.addEventListener('click', ()=>{ state.myNumber = myNumber.value.trim(); ls.set('px_my_number', state.myNumber); alert('Número salvo'); });
  saveKey.addEventListener('click', ()=>{ state.aiKey = aiKey.value.trim(); ls.set('px_ai_key', state.aiKey); alert(state.aiKey ? 'Key salva' : 'Sem key definida'); renderKeyStatus(); });

  function renderKeyStatus(){
    const k = (state.aiKey||'').trim();
    if(!k){ keyStatus.textContent = 'Key: vazia (usará /api/gemini se o backend estiver configurado)'; return; }
    keyStatus.textContent = k.startsWith('AIza') ? 'Key: formato OK' : 'Key: pode estar no formato errado (AI Studio costuma iniciar com AIza...)';
  }

  // ===== CRM Rendering =====
  function renderContacts(){
    contactsList.innerHTML = '';
    let arr = Object.values(state.contacts);
    if(state.search){
      const q = state.search.toLowerCase();
      arr = arr.filter(c => (c.name||'').toLowerCase().includes(q) || (c.phone||'').includes(q));
    }
    arr.sort((a,b)=> (b.lastTs||0)-(a.lastTs||0));
    if(arr.length===0){ contactsList.innerHTML = '<p class="muted">Sem contatos ainda.</p>'; return; }
    arr.forEach(c => {
      const div = document.createElement('div'); div.className='msg';
      div.innerHTML = `<strong>${escapeHtml(c.name||c.phone)}</strong><br>
        <small class="muted">${escapeHtml(c.phone)} — ${escapeHtml(c.lastText||'')}</small><br>
        <small class="muted">Notas: ${escapeHtml(c.notes||'')}</small>`;
      div.onclick = ()=>{ state.current = c.phone; renderThread(c.phone); };
      contactsList.appendChild(div);
    });
  }
  function renderThread(phone){
    thread.innerHTML = '';
    if(!phone){ threadTitle.textContent = 'Conversa'; return; }
    threadTitle.textContent = 'Conversa — ' + phone;
    (state.threads[phone]||[]).forEach(m => {
      const div = document.createElement('div'); div.className='msg '+(m.who==='me'?'me':'them');
      const date = new Date(m.ts||Date.now()).toLocaleString();
      div.innerHTML = `<small class="muted">${date}</small><br>${escapeHtml(m.text||'')}`;
      thread.appendChild(div);
    });
    thread.scrollTop = thread.scrollHeight;
  }
  function upsertContact(phone, data, lastText, ts){
    const c = state.contacts[phone] || {phone};
    state.contacts[phone] = { ...c, ...data, lastText, lastTs: ts };
    ls.set('px_contacts', state.contacts);
    renderContacts();
  }
  function pushMsg(phone, m){
    const arr = state.threads[phone] || [];
    arr.push(m);
    state.threads[phone] = arr;
    ls.set('px_threads', state.threads);
  }

  // Inputs
  btnAdd.addEventListener('click', ()=>{
    const phone = normPhone(cPhone.value.trim()); if(!phone) return;
    upsertContact(phone, {phone, name: cName.value.trim() || phone, notes: cNotes.value.trim()}, '', Date.now());
    cName.value = cPhone.value = cNotes.value = '';
  });
  sendMsg.addEventListener('click', async ()=>{
    const phone = state.current; const text = msgText.value.trim();
    if(!phone || !text) return;
    await waSend({to:phone, text});
    pushMsg(phone, {who:'me', text, ts: Date.now()}); msgText.value=''; renderThread(phone);
  });
  search.addEventListener('input', ()=>{ state.search = search.value; renderContacts(); });
  clearSearch.addEventListener('click', ()=>{ search.value=''; state.search=''; renderContacts(); });

  // ===== WhatsApp backend =====
  async function waStatus(){
    try{
      const r = await fetch(PIXELUP.WA_BASE + '/status');
      if(!r.ok) throw 0;
      const j = await r.json();
      waDot.classList.toggle('on', !!j.connected);
      waDot.classList.toggle('off', !j.connected);
      waLabel.textContent = j.connected ? ('WA: on' + (j.user ? ' ('+j.user+')' : '')) : 'WA: off';
      if(waStatusText) waStatusText.textContent = j.connected ? 'on' : 'off';
      return j.connected;
    }catch(e){
      waDot.classList.remove('on'); waDot.classList.add('off'); if(waStatusText) waStatusText.textContent='off'; return false;
    }
  }
  async function waSend({to, text}){
    const r = await fetch(PIXELUP.WA_BASE + '/send', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to, text}) });
    try{ return await r.json(); }catch{ return {ok:false}; }
  }
  function waEvents(){
    let es = null, timer = null;
    const open = ()=>{
      try{
        if(es){ es.close(); es=null; }
        es = new EventSource(PIXELUP.WA_BASE + '/events');
        es.onopen = ()=>{ sseBadge.textContent='SSE: ON'; sseBadge.style.color='#b5ffd0'; };
        es.onmessage = async (ev)=>{
          try{
            const data = JSON.parse(ev.data);
            if(data.type==='status'){ await waStatus(); }
            if(data.type==='message'){
              const phone = normPhone(data.from||'');
              if(!phone) return;
              upsertContact(phone, {phone, name: data.name||phone, notes:''}, data.text||'', data.ts||Date.now());
              pushMsg(phone, {who:'them', text: data.text||'', ts: data.ts||Date.now()});
              if(state.current===phone) renderThread(phone);
              if(state.botOn && phone !== normPhone(state.myNumber)){
                const reply = await geminiReply("Você é um atendente virtual da PixelUp. Responda de forma educada, objetiva e peça dados essenciais (nome, necessidade, orçamento, prazo). Se o assunto for veículos, pergunte modelo/ano/valor. Se o contato pedir humano, responda que vai acionar o atendimento.\n\nPergunta do cliente: " + (data.text||''));
                if(reply){
                  await waSend({to: phone, text: reply});
                  pushMsg(phone, {who:'me', text: reply, ts: Date.now()});
                  if(state.current===phone) renderThread(phone);
                }
              }
            }
          }catch{}
        };
        es.onerror = ()=>{
          sseBadge.textContent='SSE: OFF'; sseBadge.style.color='#ffd0d0';
          timer && clearTimeout(timer); timer = setTimeout(open, 3000);
        };
      }catch(e){
        sseBadge.textContent='SSE: OFF'; sseBadge.style.color='#ffd0d0';
        timer && clearTimeout(timer); timer = setTimeout(open, 3000);
      }
    };
    open();
  }
  btnCheckWA.addEventListener('click', waStatus);
  waStatus(); waEvents();

  // ===== Gemini (IA) =====
  function getGeminiKey(){ return (state.aiKey || '').trim(); }
  async function geminiReply(prompt){
    const key = getGeminiKey();
    const body = { contents:[{ parts:[ {text: prompt} ] }] };
    if(key){ // Front call
      const url = `https://generativelanguage.googleapis.com/v1beta/models/${PIXELUP.GEMINI_MODEL}:generateContent`;
      try{
        const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json','x-goog-api-key': key}, body: JSON.stringify(body) });
        if(!r.ok) return '';
        const j = await r.json();
        return (j?.candidates?.[0]?.content?.parts?.[0]?.text || '').trim();
      }catch(e){ return ''; }
    } else { // Backend proxy
      try{
        const r = await fetch(PIXELUP.WA_BASE + '/gemini', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({prompt}) });
        if(!r.ok) return '';
        const j = await r.json();
        return (j?.text || '').trim();
      }catch(e){ return ''; }
    }
  }

  // Bootcamp Chat
  function appendBoot(who, text){
    const div = document.createElement('div');
    div.className = 'msg ' + (who==='Você' ? 'me' : 'them');
    const date = new Date().toLocaleString();
    div.innerHTML = `<small class="muted">${date} — <b>${who}</b></small><br>${escapeHtml(text)}`;
    bootA.appendChild(div); bootA.scrollTop = bootA.scrollHeight;
  }
  bootAsk.addEventListener('click', async ()=>{
    const q = bootQ.value.trim(); if(!q) return; appendBoot('Você', q); bootQ.value='';
    const a = await geminiReply("Você é um tutor do Bootcamp PixelUp. Responda de forma clara e objetiva. Pergunta: " + q);
    appendBoot('Tutor', a || '(sem resposta)');
  });

  // Mentoria
  (function initMentoria(){
    const json = JSON.parse(document.getElementById('mentoria-data').textContent);
    const modules = json.modules || [];
    const modulesList = byId('modulesList');
    const lessonTitle = byId('lessonTitle');
    const lessonBody = byId('lessonBody');
    const toHtml = (md)=>{
      let h = (md||'')
        .replace(/^###\s(.+)$/gim, '<h3>$1</h3>')
        .replace(/^##\s(.+)$/gim, '<h2>$1</h2>')
        .replace(/^#\s(.+)$/gim, '<h1>$1</h1>')
        .replace(/\*\*(.+?)\*\*/g, '<b>$1</b>')
        .replace(/\*(.+?)\*/g, '<i>$1</i>')
        .replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>')
        .replace(/^\-\s(.+)$/gim, '<li>$1</li>');
      h = h.split(/\n\n+/).map(b => /<(h\d|ul|ol|li|p|blockquote)/.test(b.trim()) ? b : `<p>${b}</p>`).join('\n');
      return h;
    };
    modulesList.innerHTML='';
    modules.forEach((m, i)=>{
      const wrap = document.createElement('div'); wrap.className='card';
      const lessons = (m.lessons||[]).map(l => `<li><a href="#" data-mid="${m.id}" data-lid="${l.id}">${escapeHtml(l.title)}</a></li>`).join('');
      wrap.innerHTML = `<strong>${i+1}. ${escapeHtml(m.title)}</strong><ul>${lessons}</ul>`;
      modulesList.appendChild(wrap);
    });
    modulesList.addEventListener('click', (e)=>{
      if(e.target.tagName==='A'){
        e.preventDefault();
        const mid = e.target.getAttribute('data-mid');
        const lid = e.target.getAttribute('data-lid');
        const m = modules.find(x=>x.id===mid);
        const l = m?.lessons?.find(x=>x.id===lid);
        if(l){ lessonTitle.textContent = l.title; lessonBody.innerHTML = toHtml(l.content || ''); }
      }
    });
  })();

  // ===== Diagnóstico =====
  async function runDiagnostics(){
    const lines = [];
    lines.push(`<div class="tiny">Origin: <code>${escapeHtml(location.origin)}</code></div>`);
    // Proxy /api/status
    try{ const r = await fetch(PIXELUP.WA_BASE + '/status'); const ok = r.ok; const j = ok ? await r.json() : {}; lines.push(`<div>Proxy /api/status: <b>${ok?'OK':'FAIL'}</b> ${ok?escapeHtml(JSON.stringify(j)):''}</div>`); }catch{ lines.push(`<div>Proxy /api/status: <b>FAIL</b></div>`); }
    // Direto Replit /status
    try{ const r2 = await fetch(PIXELUP.REPLIT_DIRECT + '/status'); const ok2 = r2.ok; const j2 = ok2 ? await r2.json() : {}; lines.push(`<div>Direto Replit /status: <b>${ok2?'OK':'FAIL'}</b> ${ok2?escapeHtml(JSON.stringify(j2)):''}</div>`); }catch{ lines.push(`<div>Direto Replit /status: <b>FAIL</b> (CORS esperado)</div>`); }
    // /api/gemini (se sem key)
    if(!(state.aiKey||'').trim()){ try{ const r3 = await fetch(PIXELUP.WA_BASE + '/gemini', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({prompt:"ping"}) }); const ok3 = r3.ok; const j3 = ok3 ? await r3.json() : {}; lines.push(`<div>Proxy /api/gemini: <b>${ok3?'OK':'FAIL'}</b> ${ok3?escapeHtml(JSON.stringify(j3)):''}</div>`); }catch{ lines.push(`<div>Proxy /api/gemini: <b>FAIL</b></div>`); } }
    diag.innerHTML = lines.join('');
  }

  // Initial render
  renderContacts(); renderThread(null);

  </script>

  <footer>© PixelUp — SuperApp Index V6</footer>
</body>
</html>
