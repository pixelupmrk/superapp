<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PixelUp SuperApp — CRM + Mentoria + ChatBot</title>
<style>
  :root{
    --bg:#0e1013; --panel:#161a22; --muted:#8aa4c1; --txt:#eaf6ff;
    --pri:#00bfff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --br:14px;
    --bd:rgba(255,255,255,.1);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .top{position:sticky;top:0;z-index:10;background:#0f1320cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--bd)}
  .nav{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 18px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:26px;height:26px;border-radius:8px;background:radial-gradient(circle at 25% 25%,var(--pri),#012233)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--bd);background:#0f1724;color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:rgba(255,255,255,.2)}
  .btn.pri{background:linear-gradient(90deg,var(--pri),#33ccff);color:#00131d;border:none}
  .btn.ghost{background:transparent}
  .active{box-shadow:0 0 0 1px #33ccff inset}
  .grid{display:grid;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--bd);border-radius:var(--br);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,textarea,select{width:100%;background:#0b121c;border:1px solid var(--bd);border-radius:10px;padding:10px;color:var(--txt)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--bd);padding:10px;text-align:left;vertical-align:top}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .kpi{display:grid;grid-template-columns:repeat(4,minmax(160px,1fr));gap:12px}
  .card{background:#0f1724;border:1px solid var(--bd);border-radius:14px;padding:12px}
  .chat{display:grid;grid-template-rows:1fr auto;gap:10px;height:60vh}
  .msgbox{background:#0b121c;border:1px solid var(--bd);border-radius:var(--br);padding:10px;overflow:auto}
  .msg{margin:8px 0}
  .msg.me{color:#33ccff}
  .msg.bot{color:#00ff99}
  a{color:var(--pri)}
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .back{display:inline-flex;gap:8px;align-items:center}
  .kanban{display:grid;gap:12px;grid-template-columns:repeat(4,1fr)}
  .col{background:#0f1724;border:1px solid var(--bd);border-radius:12px;padding:10px;min-height:220px}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--bd);font-size:12px}
  .heat-frio{background:#1f2a37;color:#a5b4fc}
  .heat-morno{background:#2a1f37;color:#fbcfe8}
  .heat-quente{background:#37211f;color:#fecaca}
  .nowrap{white-space:nowrap}
  .nowrap a{white-space:nowrap}
  .wapp{color:#00ff99;text-decoration:none}
</style>
</head>
<body>
<div class="top">
  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <strong>PixelUp SuperApp</strong>
      <span class="muted">CRM + Mentoria + ChatBot</span>
    </div>
    <div class="tabs" id="tabs">
      <button class="btn ghost" data-route="#/dashboard">Dashboard</button>
      <button class="btn ghost" data-route="#/crm">CRM</button>
      <button class="btn ghost" data-route="#/mentoria">Mentoria</button>
      <button class="btn ghost" data-route="#/chat">ChatBot</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="bar">
    <div class="back">
      <button class="btn" id="btnBack">← Voltar</button>
      <span id="crumb" class="muted"></span>
    </div>
    <div class="muted mono">API: <span id="apiUrl"></span></div>
  </div>
  <div id="view"></div>
</div>

<script>
/* =========================
   Estado (localStorage)
========================= */
const Store = {
  _get(k, def){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(def)); }catch(_){ return def; } },
  _set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
  get contacts(){ return this._get("px_contacts", []); },
  set contacts(v){ this._set("px_contacts", v); },
  get msgCount(){ return this._get("px_msgCount", 0); },
  set msgCount(v){ this._set("px_msgCount", v); },
  // Módulos fixos + extras do usuário
  get modulesSeed(){
    return [
      {id:"m1", title:"Fundamentos — Persona", order:1, content:"Defina **persona**, dores, desejos e objeções.\n\nChecklist:\n- Nicho e subnicho\n- Mapa de dores\n- Benefícios\n- Linguagem"},
      {id:"m2", title:"Conteúdo e Calendário", order:2, content:"Roteiro de posts (reels, stories, feed).\n\nSugestões:\n- 3x Reels/semana\n- 5x Stories/dia\n- 3x Feed/semana"},
      {id:"m3", title:"Anúncios — Meta", order:3, content:"Públicos, pixel/conversões, criativos, orçamento."}
    ];
  },
  get modulesUser(){ return this._get("px_modules_user", []); },
  set modulesUser(v){ this._set("px_modules_user", v); }
};

const $ = s => document.querySelector(s);
const view = $("#view");
const apiUrlEl = $("#apiUrl");
apiUrlEl.textContent = location.origin + "/api/chat";

/* =========================
   Router + Voltar
========================= */
const routes = { "#/dashboard":Dashboard, "#/crm":CRM, "#/mentoria":Mentoria, "#/chat":Chat };
function highlight(hash){ document.querySelectorAll("[data-route]").forEach(b=> b.classList.toggle("active", b.getAttribute("data-route")===hash)); }
function router(){
  const h = location.hash || "#/dashboard";
  (routes[h] || NotFound)();
  highlight(h);
  $("#crumb").textContent = h.replace("#/","").toUpperCase();
}
window.addEventListener("hashchange", router);
$("#tabs").addEventListener("click", e=>{
  const b = e.target.closest("[data-route]"); if(!b) return;
  location.hash = b.getAttribute("data-route");
});
$("#btnBack").onclick = ()=>{
  if (history.length > 1) { history.back(); }
  else { location.hash = "#/dashboard"; }
};

/* =========================
   Helpers
========================= */
function telToWaLink(telRaw){
  // mantém só dígitos; se faltar DDI, assume Brasil 55
  const digits = String(telRaw||"").replace(/\D/g,"");
  const withDDI = digits.length===13 || digits.length===12 ? digits : ("55"+digits);
  return "https://wa.me/"+withDDI;
}
function mdToHtml(md){
  return String(md||"")
    .replace(/\n\n/g,"</p><p>")
    .replace(/\n/g,"<br>")
    .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")
    .replace(/\*(.*?)\*/g,"<em>$1</em>");
}

/* =========================
   Views
========================= */
function NotFound(){ view.innerHTML = `<div class="panel"><h2>404</h2><p class="muted">Rota não encontrada.</p></div>`; }

function Dashboard(){
  const contacts = Store.contacts.length;
  const mods = Store.modulesSeed.length + Store.modulesUser.length;
  const msgs = Store.msgCount || 0;

  view.innerHTML = `
    <div class="grid">
      <div class="kpi">
        <div class="card"><div class="muted">Contatos</div><div style="font-size:24px">${contacts}</div></div>
        <div class="card"><div class="muted">Módulos</div><div style="font-size:24px">${mods}</div></div>
        <div class="card"><div class="muted">Mensagens</div><div style="font-size:24px">${msgs}</div></div>
        <div class="card"><div class="muted">Status</div><div class="mono" style="font-size:14px">/api/chat</div></div>
      </div>

      <div class="grid" style="grid-template-columns:1fr 1fr">
        <div class="panel">
          <h3>Atalhos</h3>
          <div class="row">
            <button class="btn pri" onclick="location.hash='#/crm'">Abrir CRM</button>
            <button class="btn" onclick="location.hash='#/mentoria'">Abrir Mentoria</button>
            <button class="btn" onclick="location.hash='#/chat'">Abrir ChatBot</button>
          </div>
        </div>
        <div class="panel">
          <h3>Como funciona</h3>
          <p class="muted">• CRM e Mentoria usam <code>localStorage</code> (pode migrar para Firestore depois).<br/>
          • Chat usa a função serverless em <code>/api/chat</code> (Gemini API).</p>
        </div>
      </div>
    </div>
  `;
}

/* ===== CRM ===== */
function CRM(){
  view.innerHTML = `
    <div class="grid" style="grid-template-columns:1.2fr .8fr">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h2>Contatos</h2>
          <div class="row">
            <button class="btn" id="viewTable">Tabela</button>
            <button class="btn" id="viewKanban">Kanban</button>
          </div>
        </div>
        <div id="crmBody"></div>
      </div>
      <div class="panel">
        <h3>Novo contato</h3>
        <div class="grid">
          <div><label>Nome</label><input id="c_name" placeholder="Cliente"/></div>
          <div><label>WhatsApp</label><input id="c_whats" placeholder="(47) 9...."/></div>
          <div class="row" style="grid-template-columns:1fr 1fr; width:100%">
            <div style="flex:1"><label>Status</label>
              <select id="c_status">
                <option>Novo</option>
                <option>Em atendimento</option>
                <option>Ganhou</option>
                <option>Perdeu</option>
              </select>
            </div>
            <div style="flex:1"><label>Estágio</label>
              <select id="c_stage">
                <option>Frio</option><option>Morno</option><option>Quente</option>
              </select>
            </div>
          </div>
          <div class="row" style="grid-template-columns:1fr 1fr; width:100%">
            <div style="flex:1"><label>Origem</label>
              <select id="c_source">
                <option>Facebook</option><option>Instagram</option>
                <option>Orgânico</option><option>Indicação</option><option>Outro</option>
              </select>
            </div>
            <div style="flex:1"><label>Responsável</label><input id="c_owner" placeholder="Atendente"/></div>
          </div>
          <div><label>Data</label><input id="c_date" type="date"/></div>
          <button class="btn pri" id="save">Salvar</button>
          <div id="msg" class="muted"></div>
        </div>
      </div>
    </div>
  `;

  const body = $("#crmBody");
  $("#viewTable").onclick = renderTable;
  $("#viewKanban").onclick = renderKanban;

  function renderTable(){
    const list = Store.contacts.slice();
    body.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Nome</th><th>Whats</th><th>Status</th><th>Estágio</th>
            <th>Origem</th><th>Responsável</th><th>Data</th><th>Ações</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>`;
    const tb = $("#tb");
    if(!list.length){ tb.innerHTML = `<tr><td colspan="8" class="muted">Sem contatos ainda.</td></tr>`; return; }
    list.forEach((c, i)=>{
      const wa = telToWaLink(c.whats);
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.name||""}</td>
        <td class="nowrap"><a class="wapp" href="${wa}" target="_blank">Abrir WhatsApp</a><br><span class="muted">${c.whats||""}</span></td>
        <td>${c.status||""}</td>
        <td><span class="pill heat-${(c.stage||"frio").toLowerCase()}">${c.stage||""}</span></td>
        <td>${c.source||""}</td>
        <td>${c.owner||""}</td>
        <td>${c.date||""}</td>
        <td><button class="btn" data-del="${i}">Excluir</button></td>
      `;
      tb.appendChild(tr);
    });
    tb.addEventListener("click", e=>{
      const b = e.target.closest("[data-del]");
      if(!b) return;
      const i = +b.getAttribute("data-del");
      const upd = Store.contacts; upd.splice(i,1); Store.contacts = upd; renderTable();
    });
  }

  function renderKanban(){
    const stages = ["Novo","Em atendimento","Ganhou","Perdeu"];
    const cols = stages.map(s=>({title:s, items: Store.contacts.filter(c=> (c.status||"Novo")===s)}));
    body.innerHTML = `
      <div class="kanban" id="kb">
        ${cols.map(col=>`
          <div class="col">
            <div class="row" style="justify-content:space-between">
              <strong>${col.title}</strong>
              <span class="muted">${col.items.length}</span>
            </div>
            <div class="grid" style="margin-top:8px" data-col="${col.title}">
              ${col.items.map((c,idx)=>`
                <div class="panel" style="padding:10px">
                  <div class="row" style="justify-content:space-between">
                    <div><strong>${c.name}</strong></div>
                    <a class="wapp nowrap" href="${telToWaLink(c.whats)}" target="_blank">Whats</a>
                  </div>
                  <div class="muted" style="font-size:13px">${c.whats||""}</div>
                  <div class="row" style="margin-top:6px">
                    <span class="pill heat-${(c.stage||"frio").toLowerCase()}">${c.stage||""}</span>
                    <span class="pill">${c.source||""}</span>
                    <span class="pill">${c.owner||""}</span>
                  </div>
                  <div class="muted" style="font-size:12px;margin-top:6px">${c.date||""}</div>
                  <div class="row" style="margin-top:8px">
                    <label class="muted" style="font-size:12px">Mover:</label>
                    <select data-move="${c.id}">
                      ${stages.map(s=>`<option ${s===(c.status||"Novo")?"selected":""}>${s}</option>`).join("")}
                    </select>
                  </div>
                </div>
              `).join("")}
            </div>
          </div>
        `).join("")}
      </div>
    `;
    // mover status
    body.querySelectorAll("[data-move]").forEach(sel=>{
      sel.addEventListener("change", e=>{
        const id = sel.getAttribute("data-move");
        const to = sel.value;
        const list = Store.contacts.map(c=> c.id===id ? {...c, status:to} : c);
        Store.contacts = list;
        renderKanban();
      });
    });
  }

  // salvar novo
  $("#save").onclick = ()=>{
    const name = $("#c_name").value.trim();
    const whats = $("#c_whats").value.trim();
    const status = $("#c_status").value;
    const stage  = $("#c_stage").value;
    const source = $("#c_source").value;
    const owner  = $("#c_owner").value.trim();
    const date   = $("#c_date").value || new Date().toISOString().slice(0,10);
    if(!name){ $("#msg").textContent = "Informe o nome."; return; }
    const id = (Date.now().toString(36) + Math.random().toString(36).slice(2,6));
    const upd = Store.contacts; upd.unshift({id,name,whats,status,stage,source,owner,date});
    Store.contacts = upd;
    $("#msg").textContent = "Salvo!"; $("#c_name").value=""; $("#c_whats").value="";
    renderTable();
  };

  // default: tabela
  renderTable();
}

/* ===== Mentoria ===== */
function Mentoria(){
  const seed = Store.modulesSeed.slice().sort((a,b)=> (a.order||0)-(b.order||0));
  const extra = Store.modulesUser.slice().sort((a,b)=> (a.order||0)-(b.order||0));
  view.innerHTML = `
    <div class="grid" style="grid-template-columns:.9fr 1.1fr">
      <div class="panel">
        <h2>Módulos</h2>
        <div id="mods" class="grid"></div>
      </div>
      <div class="panel">
        <h3 id="title" class="muted">Selecione um módulo</h3>
        <div id="body" class="muted"></div>
        <hr style="border:0;border-top:1px solid var(--bd);margin:12px 0"/>
        <h3>Adicionar módulo extra</h3>
        <div class="grid">
          <input id="m_title" placeholder="Módulo X — Título"/>
          <input id="m_order" type="number" value="10"/>
          <textarea id="m_content" rows="5" placeholder="Conteúdo (Markdown simples)"></textarea>
          <button class="btn" id="m_save">Salvar</button>
          <div id="m_msg" class="muted"></div>
        </div>
      </div>
    </div>
  `;
  const list = seed.concat(extra);
  const box = $("#mods");
  function renderMods(){
    box.innerHTML = "";
    list.forEach((m,idx)=>{
      const isSeed = seed.some(s=>s.id===m.id);
      const el = document.createElement("div");
      el.className = "panel";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><strong>${m.title}</strong> <span class="muted">#${m.order||0}${isSeed?" • fixo":""}</span></div>
          <div>
            <button class="btn" data-open="${idx}">Abrir</button>
            ${isSeed ? "" : `<button class="btn" data-rm="${idx}">Excluir</button>`}
          </div>
        </div>`;
      box.appendChild(el);
    });
  }
  function open(m){ $("#title").textContent = m.title; $("#body").innerHTML = "<p>"+mdToHtml(m.content||"")+"</p>"; }
  renderMods();
  box.addEventListener("click", e=>{
    const o = e.target.closest("[data-open]"); const r = e.target.closest("[data-rm]");
    if(o){ open(list[+o.getAttribute("data-open")]); }
    if(r){
      const i = +r.getAttribute("data-rm");
      const target = list[i];
      // só permite excluir se for extra (não seed)
      if(Store.modulesSeed.find(s=>s.id===target.id)) return;
      const newExtra = Store.modulesUser.filter(x=> x.id!==target.id);
      Store.modulesUser = newExtra; location.hash = "#/mentoria"; // recarrega
    }
  });

  $("#m_save").onclick = ()=>{
    const title = $("#m_title").value.trim();
    const order = parseInt($("#m_order").value||"10",10) || 10;
    const content = $("#m_content").value.trim();
    if(!title || !content){ $("#m_msg").textContent = "Preencha título e conteúdo."; return; }
    const id = title.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    const extraList = Store.modulesUser.slice();
    const idx = extraList.findIndex(x=> x.id===id);
    const obj = {id,title,order,content};
    if(idx>=0) extraList[idx]=obj; else extraList.push(obj);
    Store.modulesUser = extraList;
    $("#m_msg").textContent = "Módulo salvo!";
    location.hash = "#/mentoria";
  };
}

/* ===== Chat ===== */
function Chat(){
  view.innerHTML = `
    <div class="panel chat">
      <div class="msgbox" id="msgs"></div>
      <div class="row">
        <input id="text" placeholder="Digite sua mensagem..."/>
        <button class="btn pri" id="send">Enviar</button>
        <span class="muted mono">→ /api/chat</span>
      </div>
    </div>
  `;
  const msgs = $("#msgs");
  function add(role, t){ const d = document.createElement("div"); d.className="msg "+role; d.textContent=(role==="me"?"USER: ":"BOT: ")+t; msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight; }
  async function send(){
    const t = $("#text").value.trim(); if(!t) return;
    $("#text").value=""; add("me", t); Store.msgCount = (Store.msgCount||0)+1;
    try{
      const r = await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})});
      const data = await r.json(); add("bot", data.reply || JSON.stringify(data));
    }catch(e){ add("bot","Erro: "+e.message); }
  }
  $("#send").onclick = send;
  $("#text").addEventListener("keydown", e=>{ if(e.key==="Enter") send(); });
}

/* boot */
router();
</script>
</body>
</html>
