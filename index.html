<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PixelUp SuperApp — Home, CRM, Mentoria e ChatBot</title>
<style>
  :root{
    --bg:#0e1013; --panel:#161a22; --muted:#8aa4c1; --txt:#eaf6ff;
    --pri:#00bfff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --br:14px;
    --bd:rgba(255,255,255,.1);
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .top{position:sticky;top:0;z-index:10;background:#0f1320cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--bd)}
  .nav{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 18px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:radial-gradient(circle at 25% 25%,var(--pri),#012233)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--bd);background:#0f1724;color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:rgba(255,255,255,.2)}
  .btn.pri{background:linear-gradient(90deg,var(--pri),#33ccff);color:#00131d;border:none}
  .btn.ghost{background:transparent}
  .active{box-shadow:0 0 0 1px #33ccff inset}
  .grid{display:grid;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--bd);border-radius:var(--br);padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,textarea,select{width:100%;background:#0b121c;border:1px solid var(--bd);border-radius:10px;padding:10px;color:var(--txt)}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid var(--bd);padding:10px;text-align:left;vertical-align:top}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .hero{position:relative;overflow:hidden;border-radius:16px;border:1px solid var(--bd);background:linear-gradient(135deg,#001424,#012a46 35%,#004f74)}
  .hero-inner{padding:36px 24px;display:grid;gap:12px;grid-template-columns:1fr 1fr;align-items:center}
  .hero-left h1{margin:0 0 8px 0;font-size:28px}
  .hero-left p{margin:0;color:var(--muted)}
  .hero-cta{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
  .hero-right{display:flex;justify-content:center;align-items:center}
  .hero-logo{width:220px;height:220px;border-radius:16px;background:
    radial-gradient(circle at 35% 30%,#33ccff,transparent 40%),
    radial-gradient(circle at 70% 60%,#00bfff,transparent 45%),
    linear-gradient(135deg,#001a2d,#002b44);
    box-shadow:0 0 120px rgba(0,191,255,.25) inset, 0 0 40px rgba(0,191,255,.35);
  }
  .bar{display:flex;gap:8px;align-items:center;justify-content:space-between;margin-bottom:8px}
  .back{display:inline-flex;gap:8px;align-items:center}
  .kanwrap{display:grid;gap:12px;grid-template-columns:repeat(5,1fr)}
  .col{background:#0f1724;border:1px solid var(--bd);border-radius:12px;padding:10px;min-height:240px}
  .drop{outline:2px dashed rgba(255,255,255,.2)}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--bd);font-size:12px}
  .heat-frio{background:#1f2a37;color:#a5b4fc}
  .heat-morno{background:#2a1f37;color:#fbcfe8}
  .heat-quente{background:#37211f;color:#fecaca}
  .nowrap{white-space:nowrap}
  .whats a{color:#00ff99;text-decoration:none}
  .chip{display:inline-block;padding:4px 8px;border:1px solid var(--bd);border-radius:999px;font-size:12px}
  .qrbox{display:flex;align-items:center;gap:16px}
  .qrcard{background:#0b121c;border:1px solid var(--bd);border-radius:12px;padding:10px;max-width:260px}
  .qrcard img{width:100%;border-radius:8px;border:6px solid #00ffcc44}
</style>
</head>
<body>
<div class="top">
  <div class="nav">
    <div class="brand">
      <div class="logo"></div>
      <strong>PixelUp SuperApp</strong>
      <span class="muted">Home • CRM • Mentoria • Chat</span>
    </div>
    <div class="tabs" id="tabs">
      <button class="btn ghost" data-route="#/home">Home</button>
      <button class="btn ghost" data-route="#/crm">CRM</button>
      <button class="btn ghost" data-route="#/mentoria">Mentoria</button>
      <button class="btn ghost" data-route="#/chat">ChatBot</button>
    </div>
  </div>
</div>

<div class="container">
  <div class="bar">
    <div class="back">
      <button class="btn" id="btnBack">← Voltar</button>
      <span id="crumb" class="muted"></span>
    </div>
    <div class="muted mono">Chat API: <span id="apiUrl"></span></div>
  </div>
  <div id="view"></div>
</div>

<script>
/** ===== CONFIG =====
 * URL pública do Replit (Baileys server) — já com a sua URL
 */
const WA_API = "https://pixelup-wa-server.pixelupmrkt.repl.co";
/** Chat API do Vercel */
const CHAT_API = "/api/chat";

/* ===== Store (localStorage) ===== */
const Store = {
  _get(k, def){ try{ return JSON.parse(localStorage.getItem(k) || JSON.stringify(def)); }catch(_){ return def; } },
  _set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },

  get contacts(){ return this._get("px_contacts", []); },
  set contacts(v){ this._set("px_contacts", v); },

  get origins(){ return this._get("px_origins", []); },
  set origins(v){ this._set("px_origins", v); },

  get msgCount(){ return this._get("px_msgCount", 0); },
  set msgCount(v){ this._set("px_msgCount", v); },

  get modulesSeed(){
    return [
      {id:"m1", title:"Fundamentos — Persona", order:1, content:"Defina **persona**, dores, desejos e objeções.\n\nChecklist:\n- Nicho e subnicho\n- Mapa de dores\n- Benefícios\n- Linguagem"},
      {id:"m2", title:"Conteúdo e Calendário", order:2, content:"Roteiro de posts (reels, stories, feed).\n\nSugestões:\n- 3x Reels/semana\n- 5x Stories/dia\n- 3x Feed/semana"},
      {id:"m3", title:"Anúncios — Meta", order:3, content:"Públicos, pixel/conversões, criativos, orçamento."}
    ];
  },
  get modulesUser(){ return this._get("px_modules_user", []); },
  set modulesUser(v){ this._set("px_modules_user", v); }
};

const $ = s => document.querySelector(s);
const view = $("#view");
$("#apiUrl").textContent = location.origin + CHAT_API;

/* ===== Router ===== */
const routes = { "#/home":Home, "#/crm":CRM, "#/mentoria":Mentoria, "#/chat":Chat };
function highlight(hash){ document.querySelectorAll("[data-route]").forEach(b=> b.classList.toggle("active", b.getAttribute("data-route")===hash)); }
function router(){ const h = location.hash || "#/home"; (routes[h] || NotFound)(); highlight(h); $("#crumb").textContent = h.replace("#/","").toUpperCase(); }
window.addEventListener("hashchange", router);
$("#tabs").addEventListener("click", e=>{ const b=e.target.closest("[data-route]"); if(!b) return; location.hash=b.getAttribute("data-route"); });
$("#btnBack").onclick = ()=>{ if(history.length>1) history.back(); else location.hash="#/home"; };

/* ===== Utils ===== */
function telToWaLink(telRaw){ const d=String(telRaw||"").replace(/\D/g,""); const withDDI = d.startsWith("55")? d : ("55"+d); return "https://wa.me/"+withDDI; }
function mdToHtml(md){ return String(md||"").replace(/\n\n/g,"</p><p>").replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>"); }

/* ===== Views ===== */
function NotFound(){ view.innerHTML = `<div class="panel"><h2>404</h2><p class="muted">Rota não encontrada.</p></div>`; }

function Home(){
  view.innerHTML = `
    <div class="hero">
      <div class="hero-inner">
        <div class="hero-left">
          <h1>PixelUp — Cresça com estratégia</h1>
          <p class="muted">Um único app com CRM, Mentoria e ChatBot para acelerar suas vendas.</p>
          <div class="hero-cta">
            <button class="btn pri" onclick="location.hash='#/crm'">Abrir CRM</button>
            <button class="btn" onclick="location.hash='#/mentoria'">Abrir Mentoria</button>
            <button class="btn" onclick="location.hash='#/chat'">Abrir ChatBot</button>
          </div>
        </div>
        <div class="hero-right"><div class="hero-logo"></div></div>
      </div>
    </div>
    <div class="grid" style="grid-template-columns:1fr 1fr;margin-top:16px">
      <div class="panel">
        <h3>Resumo</h3>
        <div class="grid" style="grid-template-columns:repeat(4,1fr)">
          <div class="panel"><div class="muted">Contatos</div><div id="k-contacts" style="font-size:24px"></div></div>
          <div class="panel"><div class="muted">Módulos</div><div id="k-mods" style="font-size:24px"></div></div>
          <div class="panel"><div class="muted">Mensagens</div><div id="k-msgs" style="font-size:24px"></div></div>
          <div class="panel"><div class="muted">API</div><div class="mono" style="font-size:14px">/api/chat</div></div>
        </div>
      </div>
      <div class="panel">
        <h3>Atalhos</h3>
        <div class="row">
          <button class="btn pri" onclick="location.hash='#/crm'">Abrir CRM</button>
          <button class="btn" onclick="location.hash='#/mentoria'">Abrir Mentoria</button>
          <button class="btn" onclick="location.hash='#/chat'">Abrir ChatBot</button>
        </div>
      </div>
    </div>
  `;
  $("#k-contacts").textContent = Store.contacts.length;
  $("#k-mods").textContent = Store.modulesSeed.length + Store.modulesUser.length;
  $("#k-msgs").textContent = Store.msgCount || 0;
}

/* ===== CRM ===== */
function CRM(){
  view.innerHTML = `
    <div class="panel">
      <h2>Novo contato</h2>
      <div class="grid" style="grid-template-columns:repeat(3,1fr)">
        <div><label>Nome</label><input id="c_name" placeholder="Cliente"/></div>
        <div><label>WhatsApp</label><input id="c_whats" placeholder="(47) 9...."/></div>
        <div><label>Responsável</label><input id="c_owner" placeholder="Atendente"/></div>
        <div>
          <label>Status</label>
          <select id="c_status">
            <option>Novo</option>
            <option>Em atendimento</option>
            <option>Proposta</option>
            <option>Vendido</option>
            <option>Perdido</option>
          </select>
        </div>
        <div>
          <label>Estágio</label>
          <select id="c_stage"><option>Frio</option><option>Morno</option><option>Quente</option></select>
        </div>
        <div>
          <label>Origem</label>
          <input list="origins" id="c_source" placeholder="Ex.: Instagram, Facebook, Indicação"/>
          <datalist id="origins"></datalist>
        </div>
        <div><label>Data</label><input id="c_date" type="date"/></div>
        <div style="align-self:end"><button class="btn pri" id="save">Salvar contato</button></div>
        <div id="msg" class="muted" style="align-self:end"></div>
      </div>
    </div>

    <div class="panel">
      <div class="row" style="justify-content:space-between">
        <h3>Conexão WhatsApp</h3>
        <span id="waStatus" class="chip">verificando…</span>
      </div>
      <div class="qrbox">
        <div class="row">
          <button class="btn" id="waStart">Conectar / Mostrar QR</button>
          <button class="btn" id="waRefresh">Atualizar status</button>
        </div>
        <div class="qrcard" id="qrPanel" style="display:none">
          <img id="qrImg" alt="QR WhatsApp"/>
        </div>
        <div class="muted">
          <p>• WhatsApp no celular → <strong>Aparelhos conectados</strong> → <strong>Conectar um aparelho</strong> → escaneie o QR.</p>
          <p>• No Replit free ele pode “dormir”; ao acordar talvez precise reconectar.</p>
        </div>
      </div>
    </div>

    <div class="grid" style="grid-template-columns:1fr 1fr">
      <div class="panel">
        <div class="row" style="justify-content:space-between">
          <h3>Contatos — Tabela</h3>
          <button class="btn" id="clearAll">Limpar Tudo</button>
        </div>
        <div id="crmTable"></div>
      </div>
      <div class="panel">
        <h3>Contatos — Kanban</h3>
        <div id="crmKanban"></div>
      </div>
    </div>
  `;

  renderOrigins();

  $("#save").onclick = saveContact;
  $("#clearAll").onclick = ()=>{
    if(confirm("Tem certeza que deseja limpar todos os contatos?")) { Store.contacts = []; renderTable(); renderKanban(); }
  };

  // WhatsApp handlers
  const waStatus = $("#waStatus");
  const qrPanel = $("#qrPanel");
  const qrImg = $("#qrImg");
  let qrTimer = null;

  async function checkWA(){
    try{
      const r = await fetch(WA_API + "/api/wa/status");
      const j = await r.json();
      if(j.connected){
        waStatus.textContent = `Conectado: ${j.user || ""}`;
        qrPanel.style.display = "none";
        if(qrTimer) { clearInterval(qrTimer); qrTimer = null; }
      } else {
        waStatus.textContent = "Desconectado";
      }
    }catch(e){ waStatus.textContent = "Erro ao verificar"; }
  }

  async function showQR(){
    try{
      const r = await fetch(WA_API + "/api/wa/qr");
      const j = await r.json();
      if(j.connected){
        waStatus.textContent = `Conectado: ${j.user || ""}`;
        qrPanel.style.display = "none";
        if(qrTimer) { clearInterval(qrTimer); qrTimer = null; }
      } else if(j.qr){
        qrImg.src = j.qr;
        qrPanel.style.display = "block";
        waStatus.textContent = "Aguardando leitura do QR…";
      } else {
        qrPanel.style.display = "none";
      }
    }catch(e){
      // ignore
    }
  }

  async function startWA(){
    try{
      const r = await fetch(WA_API + "/api/wa/start", { method:"POST" });
      const j = await r.json();
      if(j.connected){
        waStatus.textContent = `Conectado: ${j.user || ""}`;
        qrPanel.style.display = "none";
      } else {
        await showQR();
        if(!qrTimer) qrTimer = setInterval(showQR, 15000); // atualiza o QR a cada 15s
      }
    }catch(e){ waStatus.textContent = "Erro ao iniciar sessão"; console.error("startWA error:", e); }
  }

  $("#waStart").onclick = startWA;
  $("#waRefresh").onclick = checkWA;
  checkWA();

  // Renders
  renderTable();
  renderKanban();

  function renderOrigins(){
    const d = $("#origins"); d.innerHTML = "";
    Store.origins.forEach(o=>{
      const op = document.createElement("option"); op.value = o; d.appendChild(op);
    });
  }

  function saveContact(){
    const name = $("#c_name").value.trim();
    const whats = $("#c_whats").value.trim();
    const owner = $("#c_owner").value.trim();
    const status = $("#c_status").value;
    const stage  = $("#c_stage").value;
    const source = $("#c_source").value.trim();
    const date   = $("#c_date").value || new Date().toISOString().slice(0,10);
    if(!name){ $("#msg").textContent = "Informe o nome."; return; }

    const id = (Date.now().toString(36) + Math.random().toString(36).slice(2,6));
    const list = Store.contacts; list.unshift({id,name,whats,owner,status,stage,source,date});
    Store.contacts = list;

    if(source && !Store.origins.includes(source)){
      const o = Store.origins.slice(); o.unshift(source); Store.origins = [...new Set(o)].slice(0,30);
      renderOrigins();
    }

    $("#msg").textContent = "Contato salvo!";
    $("#c_name").value = ""; $("#c_whats").value = ""; $("#c_owner").value = ""; $("#c_source").value = "";
    renderTable(); renderKanban();
  }

  function renderTable(){
    const list = Store.contacts.slice();
    const box = $("#crmTable");
    box.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Nome</th><th>Whats</th><th>Status</th><th>Estágio</th>
            <th>Origem</th><th>Resp.</th><th>Data</th><th>Ações</th>
          </tr>
        </thead>
        <tbody id="tb"></tbody>
      </table>`;
    const tb = $("#tb");
    if(!list.length){ tb.innerHTML = `<tr><td colspan="8" class="muted">Sem contatos ainda.</td></tr>`; return; }
    list.forEach((c,i)=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${c.name||""}</td>
        <td class="whats nowrap">
          <a href="${telToWaLink(c.whats)}" target="_blank">WhatsApp Web</a><br>
          <span class="muted">${c.whats||""}</span>
        </td>
        <td>${c.status||""}</td>
        <td><span class="pill heat-${(c.stage||"frio").toLowerCase()}">${c.stage||""}</span></td>
        <td>${c.source||""}</td>
        <td>${c.owner||""}</td>
        <td>${c.date||""}</td>
        <td class="nowrap">
          <button class="btn" data-send="${i}">Enviar Whats</button>
          <button class="btn" data-del="${i}">Excluir</button>
        </td>
      `;
      tb.appendChild(tr);
    });
    tb.addEventListener("click", async e=>{
      const send = e.target.closest("[data-send]");
      const del  = e.target.closest("[data-del]");
      if(send){
        const i = +send.getAttribute("data-send");
        const c = Store.contacts[i];
        const text = prompt("Mensagem para enviar via WhatsApp:", `Olá ${c.name}, tudo bem?`);
        if(!text) return;
        try{
          const r = await fetch(WA_API + "/api/wa/send", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ to: c.whats, text })
          });
          const j = await r.json();
          if(j?.ok) alert("Enviado ✅");
          else alert("Falha ao enviar: " + (j?.error || "desconhecido"));
        }catch(err){ alert("Erro ao enviar: " + err.message); }
      }
      if(del){
        const i = +del.getAttribute("data-del");
        const upd = Store.contacts; upd.splice(i,1); Store.contacts = upd; renderTable(); renderKanban();
      }
    });
  }

  function renderKanban(){
    const stages = ["Novo","Em atendimento","Proposta","Vendido","Perdido"];
    const cols = stages.map(s=>({title:s, items: Store.contacts.filter(c=> (c.status||"Novo")===s)}));
    const box = $("#crmKanban");
    box.innerHTML = `
      <div class="kanwrap">
        ${cols.map(col=>`
          <div class="col" data-col="${col.title}">
            <div class="row" style="justify-content:space-between">
              <strong>${col.title}</strong>
              <span class="muted">${col.items.length}</span>
            </div>
            <div class="grid" style="margin-top:8px">
              ${col.items.map(c=>`
                <div class="panel" draggable="true" data-id="${c.id}" style="padding:10px">
                  <div class="row" style="justify-content:space-between">
                    <div><strong>${c.name}</strong></div>
                    <a class="muted nowrap" href="${telToWaLink(c.whats)}" target="_blank">Web</a>
                  </div>
                  <div class="muted" style="font-size:13px">${c.whats||""}</div>
                  <div class="row" style="margin-top:6px">
                    <span class="pill heat-${(c.stage||"frio").toLowerCase()}">${c.stage||""}</span>
                    <span class="pill">${c.source||""}</span>
                    <span class="pill">${c.owner||""}</span>
                  </div>
                  <div class="muted" style="font-size:12px;margin-top:6px">${c.date||""}</div>
                </div>
              `).join("")}
            </div>
          </div>
        `).join("")}
      </div>
    `;
    box.querySelectorAll("[draggable='true']").forEach(card=>{
      card.addEventListener("dragstart", e=>{
        e.dataTransfer.setData("text/plain", card.getAttribute("data-id"));
      });
    });
    box.querySelectorAll(".col").forEach(col=>{
      col.addEventListener("dragover", e=>{ e.preventDefault(); col.classList.add("drop"); });
      col.addEventListener("dragleave", ()=> col.classList.remove("drop"));
      col.addEventListener("drop", e=>{
        e.preventDefault();
        col.classList.remove("drop");
        const id = e.dataTransfer.getData("text/plain");
        const to = col.getAttribute("data-col");
        const list = Store.contacts.map(c=> c.id===id ? {...c, status:to} : c);
        Store.contacts = list;
        renderKanban(); renderTable();
      });
    });
  }
}

/* ===== Mentoria ===== */
function Mentoria(){
  const seed = Store.modulesSeed.slice().sort((a,b)=> (a.order||0)-(b.order||0));
  const extra = Store.modulesUser.slice().sort((a,b)=> (a.order||0)-(b.order||0));
  view.innerHTML = `
    <div class="grid" style="grid-template-columns:.9fr 1.1fr">
      <div class="panel">
        <h2>Módulos</h2>
        <div id="mods" class="grid"></div>
      </div>
      <div class="panel">
        <h3 id="title" class="muted">Selecione um módulo</h3>
        <div id="body" class="muted"></div>
        <hr style="border:0;border-top:1px solid var(--bd);margin:12px 0"/>
        <h3>Adicionar módulo extra</h3>
        <div class="grid">
          <input id="m_title" placeholder="Módulo X — Título"/>
          <input id="m_order" type="number" value="10"/>
          <textarea id="m_content" rows="5" placeholder="Conteúdo (Markdown simples)"></textarea>
          <button class="btn" id="m_save">Salvar</button>
          <div id="m_msg" class="muted"></div>
        </div>
      </div>
    </div>
  `;
  const list = seed.concat(extra);
  const box = $("#mods");
  function renderMods(){
    box.innerHTML = "";
    list.forEach((m,idx)=>{
      const isSeed = seed.some(s=>s.id===m.id);
      const el = document.createElement("div");
      el.className = "panel";
      el.innerHTML = `
        <div class="row" style="justify-content:space-between">
          <div><strong>${m.title}</strong> <span class="muted">#${m.order||0}${isSeed?" • fixo":""}</span></div>
          <div>
            <button class="btn" data-open="${idx}">Abrir</button>
            ${isSeed ? "" : `<button class="btn" data-rm="${idx}">Excluir</button>`}
          </div>
        </div>`;
      box.appendChild(el);
    });
  }
  function open(m){ $("#title").textContent = m.title; $("#body").innerHTML = "<p>"+mdToHtml(m.content||"")+"</p>"; }
  renderMods();
  box.addEventListener("click", e=>{
    const o = e.target.closest("[data-open]"); const r = e.target.closest("[data-rm]");
    if(o){ open(list[+o.getAttribute("data-open")]); }
    if(r){
      const i = +r.getAttribute("data-rm");
      const target = list[i];
      if(Store.modulesSeed.find(s=>s.id===target.id)) return;
      const newExtra = Store.modulesUser.filter(x=> x.id!==target.id);
      Store.modulesUser = newExtra; location.hash = "#/mentoria";
    }
  });

  $("#m_save").onclick = ()=>{
    const title = $("#m_title").value.trim();
    const order = parseInt($("#m_order").value||"10",10) || 10;
    const content = $("#m_content").value.trim();
    if(!title || !content){ $("#m_msg").textContent = "Preencha título e conteúdo."; return; }
    const id = title.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    const extraList = Store.modulesUser.slice();
    const idx = extraList.findIndex(x=> x.id===id);
    const obj = {id,title,order,content};
    if(idx>=0) extraList[idx]=obj; else extraList.push(obj);
    Store.modulesUser = extraList;
    $("#m_msg").textContent = "Módulo salvo!";
    location.hash = "#/mentoria";
  };
}

/* ===== Chat ===== */
function Chat(){
  view.innerHTML = `
    <div class="panel" style="display:grid;grid-template-rows:1fr auto;gap:10px;height:60vh">
      <div class="panel" id="msgs" style="overflow:auto"></div>
      <div class="row">
        <input id="text" placeholder="Digite sua mensagem..."/>
        <button class="btn pri" id="send">Enviar</button>
        <span class="muted mono">→ ${CHAT_API}</span>
      </div>
    </div>
  `;
  const msgs = $("#msgs");
  function add(role, t){ const d = document.createElement("div"); d.style.margin="8px 0"; d.style.color = role==="me"?"#33ccff":"#00ff99"; d.textContent=(role==="me"?"USER: ":"BOT: ")+t; msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight; }
  async function send(){
    const t = $("#text").value.trim(); if(!t) return;
    $("#text").value=""; add("me", t); Store.msgCount = (Store.msgCount||0)+1;
    try{
      const r = await fetch(CHAT_API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})});
      const data = await r.json(); add("bot", data.reply || JSON.stringify(data));
    }catch(e){ add("bot","Erro: "+e.message); }
  }
  $("#send").onclick = send;
  $("#text").addEventListener("keydown", e=>{ if(e.key==="Enter") send(); });
}

/* boot */
router();
</script>
</body>
</html>
