<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PixelUp SuperApp — Home, CRM, Mentoria e ChatBot</title>
<style>
  :root{ --bg:#0e1013; --panel:#161a22; --muted:#8aa4c1; --txt:#eaf6ff; --pri:#00bfff; --bd:rgba(255,255,255,.1); }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,system-ui,Segoe UI,Arial,sans-serif}
  .container{max-width:1200px;margin:0 auto;padding:18px}
  .top{position:sticky;top:0;z-index:10;background:#0f1320cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--bd)}
  .nav{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:12px 18px}
  .brand{display:flex;gap:10px;align-items:center}
  .logo{width:28px;height:28px;border-radius:8px;background:radial-gradient(circle at 25% 25%,var(--pri),#012233)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .btn{appearance:none;border:1px solid var(--bd);background:#0f1724;color:var(--txt);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.pri{background:linear-gradient(90deg,var(--pri),#33ccff);color:#00131d;border:none}
  .active{box-shadow:0 0 0 1px #33ccff inset}
  .grid{display:grid;gap:16px} .panel{background:#161a22;border:1px solid var(--bd);border-radius:12px;padding:16px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,textarea,select{width:100%;background:#0b121c;border:1px solid var(--bd);border-radius:10px;padding:10px;color:var(--txt)}
  table{width:100%;border-collapse:collapse} th,td{border-bottom:1px solid var(--bd);padding:10px;text-align:left;vertical-align:top}
  .muted{color:var(--muted)} .chip{display:inline-block;padding:4px 8px;border:1px solid var(--bd);border-radius:999px;font-size:12px}
  .qrcard{background:#0b121c;border:1px solid var(--bd);border-radius:12px;padding:10px;max-width:260px}
  .qrcard img{width:100%;border-radius:8px;border:6px solid #00ffcc44}
</style>
</head>
<body>
<div class="top">
  <div class="nav">
    <div class="brand"><div class="logo"></div><strong>PixelUp SuperApp</strong><span class="muted">Home • CRM • Mentoria • Chat</span></div>
    <div class="tabs" id="tabs">
      <button class="btn" data-route="#/home">Home</button>
      <button class="btn" data-route="#/crm">CRM</button>
      <button class="btn" data-route="#/mentoria">Mentoria</button>
      <button class="btn" data-route="#/chat">ChatBot</button>
      <button class="btn" data-route="#/whatsapp">WhatsApp</button>
    </div>
  </div>
</div>
<div class="container">
  <div class="row" style="justify-content:space-between;margin:10px 0">
    <div class="row"><button class="btn" id="btnBack">← Voltar</button><span id="crumb" class="muted"></span></div>
    <div class="muted">APIs: <span id="apiUrl"></span></div>
  </div>
  <div id="view" class="grid"></div>
</div>
<script>
const WA_API   = "/api/wa";
const CHAT_API = "/api/chat";
const $ = s=>document.querySelector(s);
$("#apiUrl").textContent = `WA ${WA_API} • CHAT ${CHAT_API}`;

// Router
const routes = {"#/home":Home,"#/crm":CRM,"#/mentoria":Mentoria,"#/chat":Chat,"#/whatsapp":Whats};
function router(){ const h=location.hash||"#/home"; (routes[h]||Home)(); document.querySelectorAll("[data-route]").forEach(b=>b.classList.toggle("active", b.getAttribute("data-route")===h)); $("#crumb").textContent=h.replace("#/","").toUpperCase(); }
window.addEventListener("hashchange", router);
document.getElementById("tabs").addEventListener("click", e=>{ const b=e.target.closest("[data-route]"); if(b) location.hash=b.getAttribute("data-route"); });
document.getElementById("btnBack").onclick = ()=>{ if(history.length>1) history.back(); else location.hash="#/home"; };

// Simple store
const Store={_g:(k,d)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(d))}catch(_){return d}},_s:(k,v)=>localStorage.setItem(k,JSON.stringify(v)),
get contacts(){return this._g("px_contacts",[])},set contacts(v){this._s("px_contacts",v)},get msgCount(){return this._g("px_msgCount",0)},set msgCount(v){this._s("px_msgCount",v)}};
function telToWaLink(x){const d=String(x||"").replace(/\D/g,"");return "https://wa.me/"+(d.startsWith("55")?d:"55"+d)}

// Views
function Home(){ $("#view").innerHTML = `<div class="panel"><h2>Bem-vindo</h2><p class="muted">Use as abas acima.</p></div>`; }

function CRM(){
  $("#view").innerHTML = `
  <div class="panel"><h2>Novo contato</h2>
    <div class="grid" style="grid-template-columns:repeat(3,1fr)">
      <div><label>Nome</label><input id="c_name"></div>
      <div><label>WhatsApp</label><input id="c_whats"></div>
      <div><label>Responsável</label><input id="c_owner" value="Atendente"></div>
      <div><label>Status</label><select id="c_status"><option>Novo</option><option>Em atendimento</option><option>Proposta</option><option>Vendido</option><option>Perdido</option></select></div>
      <div><label>Estágio</label><select id="c_stage"><option>Frio</option><option>Morno</option><option>Quente</option></select></div>
      <div><label>Origem</label><input id="c_source" placeholder="Instagram / Facebook / Indicação"></div>
      <div><label>Data</label><input id="c_date" type="date"></div>
      <div style="align-self:end"><button class="btn pri" id="save">Salvar</button></div>
    </div>
  </div>
  <div class="panel">
    <h3>Contatos</h3>
    <div id="list"></div>
  </div>`;
  const listEl=$("#list"); const render=()=>{const L=Store.contacts; listEl.innerHTML=L.length?`<table><thead><tr><th>Nome</th><th>Whats</th><th>Status</th><th>Estágio</th><th>Origem</th><th>Resp.</th><th>Data</th><th></th></tr></thead><tbody>${L.map((c,i)=>`<tr><td>${c.name}</td><td><a href="${telToWaLink(c.whats)}" target="_blank">${c.whats}</a></td><td>${c.status}</td><td>${c.stage}</td><td>${c.source||""}</td><td>${c.owner||""}</td><td>${c.date||""}</td><td><button class="btn" data-del="${i}">Excluir</button></td></tr>`).join("")}</tbody></table>`:`<p class="muted">Sem contatos.</p>`;};
  $("#save").onclick=()=>{const c={id:Date.now().toString(36),name:$("#c_name").value.trim(),whats:$("#c_whats").value.trim(),owner:$("#c_owner").value.trim(),status:$("#c_status").value,stage:$("#c_stage").value,source:$("#c_source").value.trim(),date:$("#c_date").value||new Date().toISOString().slice(0,10)}; if(!c.name)return; const L=Store.contacts; L.unshift(c); Store.contacts=L; render(); $("#c_name").value=$("#c_whats").value=$("#c_owner").value=$("#c_source").value=""; };
  $("#list").addEventListener("click",e=>{const b=e.target.closest("[data-del]"); if(b){const i=+b.dataset.del; const L=Store.contacts; L.splice(i,1); Store.contacts=L; render();}});
  render();
}

function Mentoria(){ $("#view").innerHTML = `<div class="panel"><h2>Mentoria</h2><p class="muted">Adicione seus módulos fixos aqui.</p></div>`; }

function Chat(){
  $("#view").innerHTML = `
  <div class="panel" style="display:grid;grid-template-rows:1fr auto;gap:10px;height:60vh">
    <div class="panel" id="msgs" style="overflow:auto"></div>
    <div class="row"><input id="text" placeholder="Digite sua mensagem..."/><button class="btn pri" id="send">Enviar</button><span class="muted">→ ${CHAT_API}</span></div>
  </div>`;
  const msgs=$("#msgs"); const add=(r,t)=>{const d=document.createElement("div"); d.style.margin="8px 0"; d.style.color=r==="me"?"#33ccff":"#00ff99"; d.textContent=(r==="me"?"USER: ":"BOT: ")+t; msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight;};
  async function send(){ const t=$("#text").value.trim(); if(!t) return; $("#text").value=""; add("me",t); Store.msgCount=(Store.msgCount||0)+1; try{ const r=await fetch(CHAT_API,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t})}); const j=await r.json(); add("bot",j.reply||JSON.stringify(j)); }catch(e){ add("bot","Erro: "+e.message);} }
  $("#send").onclick=send; $("#text").addEventListener("keydown",e=>{if(e.key==="Enter")send();});
}

function Whats(){
  $("#view").innerHTML = `
  <div class="panel">
    <div class="row" style="justify-content:space-between"><h2>Conexão WhatsApp</h2><span id="waStatus" class="chip">verificando…</span></div>
    <div class="row" style="gap:12px;margin-bottom:12px"><button class="btn" id="waStart">Conectar / Mostrar QR</button><button class="btn" id="waRefresh">Atualizar status</button></div>
    <div class="qrcard" id="qrPanel" style="display:none"><img id="qrImg" alt="QR WhatsApp"/></div>
    <p class="muted">• WhatsApp → Aparelhos conectados → Conectar um aparelho → escaneie o QR.</p>
  </div>`;
  const st=$("#waStatus"), qrP=$("#qrPanel"), qr=$("#qrImg"); let timer=null;
  async function safeJson(res){ const t=await res.text(); try{return JSON.parse(t)}catch{ throw new Error("Resposta não-JSON: "+t.slice(0,120)); } }
  async function check(){ try{ const r=await fetch(WA_API+"/status"); const j=await safeJson(r); if(j.connected){st.textContent="Conectado ✅"; qrP.style.display="none"; if(timer){clearInterval(timer);timer=null;}} else {st.textContent="Desconectado"; if(j.qr){qr.src=j.qr; qrP.style.display="block";}} }catch(e){ st.textContent="Erro ao verificar"; console.error(e);} }
  async function showQR(){ try{ const r=await fetch(WA_API+"/status"); const j=await safeJson(r); if(j.connected){st.textContent="Conectado ✅"; qrP.style.display="none"; if(timer){clearInterval(timer);timer=null;}} else if(j.qr){qr.src=j.qr; qrP.style.display="block"; st.textContent="Aguardando leitura do QR…";} }catch(_){} }
  async function start(){ try{ const r=await fetch(WA_API+"/start",{method:"POST",headers:{"Content-Type":"application/json"},body:"{}"}); const j=await safeJson(r); if(j.connected){st.textContent="Conectado ✅"; qrP.style.display="none";} else { await showQR(); if(!timer) timer=setInterval(showQR,15000);} }catch(e){ st.textContent="Erro ao iniciar sessão"; console.error(e);} }
  $("#waStart").onclick=start; $("#waRefresh").onclick=check; check();
}

router();
</script>
</body>
</html>
