<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PixelUp CRM</title>
<meta name="color-scheme" content="dark">
<style>
:root {
  --bg: #0b1016;
  --panel: #0f1722;
  --muted: #9fb1c4;
  --text: #eaf6ff;
  --brand: #00b3ff;
  --line: #12334c;
  --ok: #16a34a;
  --warn: #f59e0b;
}

body {
  margin: 0;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background-color: var(--bg);
  color: var(--text);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.topbar {
  display: flex;
  align-items: center;
  gap: 1.5rem;
  padding: 1rem;
  background: rgba(9, 16, 24, .8);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid var(--line);
  position: sticky;
  top: 0;
  z-index: 10;
}

.brand {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-weight: 800;
  font-size: 1.25rem;
}

.dot {
  width: 1rem;
  height: 1rem;
  border-radius: 50%;
  background: linear-gradient(180deg, var(--brand), #39dbff);
}

nav {
  margin-left: auto;
}

nav a {
  padding: 0.75rem 1rem;
  border-radius: 0.75rem;
  text-decoration: none;
  color: #d7eeff;
  border: 1px solid transparent;
  transition: all 0.2s;
}

nav a.active, nav a:hover {
  border-color: #174464;
  background: rgba(0, 179, 255, .08);
}

main {
  flex: 1;
  max-width: 1200px;
  margin: 1.5rem auto;
  padding: 0 1rem;
  width: 100%;
}

.page {
  display: none;
}

.page.active {
  display: block;
}

.card {
  background: linear-gradient(180deg, rgba(14, 22, 33, .9), rgba(9, 15, 24, .9));
  border: 1px solid var(--line);
  border-radius: 1rem;
  padding: 2rem;
  box-shadow: 0 10px 40px rgba(0, 179, 255, .06);
}

h1 {
  font-size: 1.75rem;
  margin: 0 0 1rem;
}

h2 {
  font-size: 1.25rem;
  margin: 1.5rem 0 0.5rem;
}

.muted {
  color: var(--muted);
}

.small {
  font-size: 0.75rem;
}

.row {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
  align-items: center;
}

.grid {
  display: grid;
  gap: 1.5rem;
  grid-template-columns: 1.1fr 0.9fr;
}

@media (max-width: 900px) {
  .grid {
    grid-template-columns: 1fr;
  }
}

input, textarea {
  width: 100%;
  padding: 0.75rem 1rem;
  border-radius: 0.75rem;
  background: #0b1520;
  border: 1px solid #183149;
  color: #dff1ff;
  outline: none;
  transition: border-color 0.2s;
}

input:focus, textarea:focus {
  border-color: var(--brand);
}

.btn {
  appearance: none;
  border: none;
  cursor: pointer;
  padding: 0.75rem 1rem;
  border-radius: 0.75rem;
  color: #05121b;
  font-weight: 700;
  background: linear-gradient(180deg, #79d2ff, #27b0ff);
  box-shadow: 0 4px 18px rgba(0, 179, 255, .3);
  transition: all 0.2s;
}

.btn:hover {
  opacity: 0.9;
  transform: translateY(-2px);
}

.btn.secondary {
  color: #dbeafe;
  background: transparent;
  border: 1px solid #1b4663;
  box-shadow: none;
}

.badge {
  display: inline-flex;
  gap: 0.5rem;
  align-items: center;
  padding: 0.5rem 0.75rem;
  border-radius: 999px;
  border: 1px solid #123249;
  background: #09151f;
  color: #cfeaff;
  font-size: 0.75rem;
  font-weight: 700;
}

.b-ok {
  border-color: #134e27;
  color: #b7ffd3;
  background: #0a1a12;
}

.b-warn {
  border-color: #614214;
  color: #ffe9bd;
  background: #1b1407;
}

.table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.table th, .table td {
  border-bottom: 1px solid #102437;
  padding: 0.75rem 0.5rem;
  text-align: left;
}

.kb {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  min-height: 250px;
}

.kb-col {
  border: 1px solid #13304a;
  border-radius: 1rem;
  padding: 1rem;
  background: #0b1622;
  min-height: 200px;
  display: flex;
  flex-direction: column;
}

.kb-col b {
  margin-bottom: 0.5rem;
  font-size: 1rem;
}

.kb-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
  flex: 1;
}

.kb-card {
  border: 1px solid #143149;
  border-radius: 0.75rem;
  padding: 0.75rem;
  background: #0a1824;
  cursor: grab;
}

.kb-card:active {
  cursor: grabbing;
}

.qrbox {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 280px;
  border: 1px dashed #1f415c;
  border-radius: 1rem;
  background: #08121a;
  overflow: hidden;
  text-align: center;
  padding: 1rem;
}

.qrimg {
  max-width: 100%;
  height: auto;
  image-rendering: pixelated;
}

.code {
  font-family: ui-monospace, Menlo, Consolas, monospace;
  font-size: 0.8rem;
  color: #bcd7f0;
}

.log {
  max-height: 200px;
  overflow-y: auto;
  background: #08131b;
  border: 1px solid #15324a;
  border-radius: 0.75rem;
  padding: 0.75rem;
  font-size: 0.8rem;
  margin-top: 1rem;
}

.log div {
  padding: 0.2rem 0;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}

.log div:last-child {
  border-bottom: none;
}
</style>
</head>
<body>
<header class="topbar">
  <div class="brand"><span class="dot"></span> PixelUp CRM</div>
  <nav>
    <a href="#crm" class="active">CRM</a>
    <a href="#whatsapp">WhatsApp</a>
  </nav>
</header>

<main>
  <section id="crm" class="page active">
    <div class="card grid">
      <section>
        <h1>Contatos</h1>
        <div class="row" id="authRow">
          <span id="authBadge" class="badge b-warn">⏺ Deslogado</span>
          <button id="btnLogout" class="btn secondary" style="display:none">Sair</button>
        </div>

        <div id="loginBox" style="margin-top:1.5rem">
          <div class="row" style="margin-bottom:0.75rem">
            <input id="email" type="email" placeholder="E-mail"/>
            <input id="pass" type="password" placeholder="Senha"/>
          </div>
          <div class="row">
            <button id="btnLogin" class="btn">Entrar</button>
            <button id="btnSignup" class="btn secondary">Criar conta</button>
          </div>
          <p class="small muted" style="margin-top:0.5rem">Autenticação Firebase. Sem Firebase, usa <b>localStorage</b>.</p>
        </div>

        <div id="contactForm" style="display:none;margin-top:1.5rem">
          <h2>Novo contato</h2>
          <div class="row" style="margin-bottom:0.75rem">
            <input id="c_name" placeholder="Nome"/>
            <input id="c_phone" placeholder="Telefone (DDD)"/>
          </div>
          <div class="row">
            <input id="c_email" placeholder="E-mail"/>
          </div>
          <textarea id="c_notes" rows="3" placeholder="Observações" style="margin-top:0.75rem"></textarea>
          <div class="row" style="margin-top:0.75rem">
            <button id="btnSaveContact" class="btn">Salvar contato</button>
            <span id="saveInfo" class="muted small"></span>
          </div>

          <h2 style="margin-top:2rem">Lista de Contatos</h2>
          <div style="overflow-x: auto;">
            <table class="table" id="tblContacts">
              <thead><tr><th>Nome</th><th>Telefone</th><th>E-mail</th><th>Obs.</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <aside>
        <h2>Kanban</h2>
        <div class="kb" id="kanban">
          <div class="kb-col" data-col="novo"><b>Novo</b><div class="kb-list"></div></div>
          <div class="kb-col" data-col="progresso"><b>Em Progresso</b><div class="kb-list"></div></div>
          <div class="kb-col" data-col="fechado"><b>Fechado</b><div class="kb-list"></div></div>
        </div>
        <div class="row" style="margin-top:1rem">
          <input id="leadTitle" placeholder="Título do lead"/>
          <button id="btnAddLead" class="btn">Adicionar lead</button>
        </div>
        <p class="small muted" style="margin-top:0.5rem">Arraste os cards. Estado salvo no Firestore (logado) ou localStorage.</p>
      </aside>
    </div>
  </section>

  <section id="whatsapp" class="page">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <div class="muted small">APIs: <span class="code">/api/wa/status • /start • /qr</span></div>
          <h1>Conexão WhatsApp</h1>
        </div>
        <div id="waStatus" class="badge b-warn">⏺ Desconectado</div>
      </div>
      <div class="row" style="margin:1rem 0">
        <button id="waConnect" class="btn">Conectar / Mostrar QR</button>
        <button id="waStatusBtn" class="btn secondary">Atualizar status</button>
      </div>
      <div class="qrbox" id="qrBox">
        <div class="muted">Clique em <b>Conectar / Mostrar QR</b> e escaneie no WhatsApp → Aparelhos conectados.</div>
      </div>
      <p class="small muted" style="margin-top:1rem">O bot responde automaticamente (saudação/menu). Contatos podem ser gravados no CRM via Firestore Admin no Replit.</p>
      <div class="log" id="waLog"></div>
    </div>
  </section>
</main>

<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

<script>
// Router
document.querySelectorAll('nav a').forEach(link => {
  link.addEventListener('click', (e) => {
    e.preventDefault();
    const targetId = e.target.getAttribute('href').substring(1);
    document.querySelectorAll('.page').forEach(page => {
      page.classList.remove('active');
    });
    document.getElementById(targetId).classList.add('active');
    document.querySelectorAll('nav a').forEach(navLink => navLink.classList.remove('active'));
    e.target.classList.add('active');
  });
});

// Firebase (mantido na versão compatível para simplificar)
const firebaseConfig = {
  apiKey: "AIzaSyCjuQZP80sd4FtX83Zp5YgDmySpn7s6GZw",
  authDomain: "pixelup-crm.firebaseapp.com",
  projectId: "pixelup-crm",
  storageBucket: "pixelup-crm.firebasestorage.app",
  messagingSenderId: "286127901698",
  appId: "1:286127901698:web:f4dd954937fad94757ab1b"
};

let fb = { ok: false };
let auth = null;
let db = null;

try {
  const app = firebase.initializeApp(firebaseConfig);
  auth = firebase.auth();
  db = firebase.firestore();
  fb.ok = true;
  console.log("Firebase inicializado com sucesso.");
} catch (e) {
  console.warn("Sem Firebase. Usando localStorage para armazenamento local.");
}

const authBadge = document.getElementById("authBadge");
const loginBox = document.getElementById("loginBox");
const btnLogout = document.getElementById("btnLogout");
const contactForm = document.getElementById("contactForm");
const tblBody = document.querySelector("#tblContacts tbody");
const kb = document.getElementById("kanban");

const getUID = () => fb.ok && auth.currentUser ? auth.currentUser.uid : "local";

// Auth
const updateAuthUI = (user) => {
  if (user) {
    authBadge.className = "badge b-ok";
    authBadge.textContent = "✅ " + (user.email || "Logado");
    loginBox.style.display = "none";
    btnLogout.style.display = "";
    contactForm.style.display = "";
    loadContacts();
    loadKanban();
  } else {
    authBadge.className = "badge b-warn";
    authBadge.textContent = "⏺ Deslogado";
    loginBox.style.display = "";
    btnLogout.style.display = "none";
    contactForm.style.display = "none";
    // Limpar listas
    tblBody.innerHTML = "";
    kb.querySelectorAll(".kb-list").forEach(l => l.innerHTML = "");
  }
};

if (fb.ok) {
  auth.onAuthStateChanged(updateAuthUI);
} else {
  updateAuthUI({ email: "modo local" });
}

document.getElementById("btnLogin").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("pass").value;
  if (!email || !pass) return alert("Preencha e-mail e senha.");
  if (!fb.ok) return alert("O Firebase não foi inicializado. Use o modo local.");
  try {
    await auth.signInWithEmailAndPassword(email, pass);
  } catch (e) {
    alert("Erro ao fazer login: " + e.message);
  }
};

document.getElementById("btnSignup").onclick = async () => {
  const email = document.getElementById("email").value.trim();
  const pass = document.getElementById("pass").value;
  if (!email || !pass) return alert("Preencha e-mail e senha.");
  if (!fb.ok) return alert("O Firebase não foi inicializado. Use o modo local.");
  try {
    await auth.createUserWithEmailAndPassword(email, pass);
  } catch (e) {
    alert("Erro ao criar conta: " + e.message);
  }
};

btnLogout.onclick = () => {
  if (fb.ok) {
    auth.signOut();
  } else {
    localStorage.clear();
    location.reload();
  }
};

// Contacts
const renderContacts = (list) => {
  tblBody.innerHTML = "";
  list.sort((a, b) => b.ts - a.ts).forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${c.name || ""}</td><td>${c.phone || ""}</td><td>${c.email || ""}</td><td>${c.notes || ""}</td>`;
    tblBody.appendChild(tr);
  });
};

const loadContacts = () => {
  const uid = getUID();
  if (fb.ok) {
    db.collection("users").doc(uid).collection("contacts").orderBy("ts", "desc").onSnapshot(snap => {
      const arr = [];
      snap.forEach(d => arr.push(d.data()));
      renderContacts(arr);
    }, (error) => {
      console.error("Erro ao carregar contatos do Firestore: ", error);
    });
  } else {
    const arr = JSON.parse(localStorage.getItem("px_contacts_" + uid) || "[]");
    renderContacts(arr);
  }
};

document.getElementById("btnSaveContact").onclick = async () => {
  const c = {
    name: c_name.value.trim(),
    phone: c_phone.value.trim(),
    email: c_email.value.trim(),
    notes: c_notes.value.trim(),
    ts: Date.now()
  };
  if (!c.name) {
    alert("Por favor, preencha o nome do contato.");
    return;
  }
  const info = document.getElementById("saveInfo");
  info.textContent = "Salvando...";
  try {
    if (fb.ok) {
      await db.collection("users").doc(getUID()).collection("contacts").add(c);
    } else {
      const key = "px_contacts_" + getUID();
      const arr = JSON.parse(localStorage.getItem(key) || "[]");
      arr.push(c);
      localStorage.setItem(key, JSON.stringify(arr));
      loadContacts();
    }
    info.textContent = "Salvo com sucesso!";
    c_name.value = c_phone.value = c_email.value = c_notes.value = "";
  } catch (e) {
    info.textContent = "Erro ao salvar: " + e.message;
  }
  setTimeout(() => info.textContent = "", 3000);
};

// Kanban
const createKanbanCard = (data) => {
  const el = document.createElement("div");
  el.className = "kb-card";
  el.draggable = true;
  el.dataset.id = data.ts;
  el.dataset.col = data.col;
  el.innerHTML = `<div>${data.title}</div>`;
  return el;
};

const renderKanban = (cards) => {
  kb.querySelectorAll(".kb-list").forEach(list => list.innerHTML = "");
  cards.forEach(cardData => {
    const cardElement = createKanbanCard(cardData);
    const list = kb.querySelector(`.kb-col[data-col="${cardData.col}"] .kb-list`);
    if (list) {
      list.appendChild(cardElement);
    }
  });
};

const saveKanban = () => {
  const cards = [...kb.querySelectorAll(".kb-card")].map(el => ({
    title: el.textContent.trim(),
    col: el.dataset.col,
    ts: Number(el.dataset.id)
  }));
  const uid = getUID();
  if (fb.ok) {
    db.collection("users").doc(uid).set({ kanban: cards }, { merge: true });
  } else {
    localStorage.setItem("px_kanban_" + uid, JSON.stringify(cards));
  }
};

const loadKanban = () => {
  const uid = getUID();
  if (fb.ok) {
    db.collection("users").doc(uid).onSnapshot(doc => {
      const data = doc.data();
      const cards = data && data.kanban ? data.kanban : [];
      renderKanban(cards);
    }, (error) => {
      console.error("Erro ao carregar Kanban do Firestore: ", error);
    });
  } else {
    const cards = JSON.parse(localStorage.getItem("px_kanban_" + uid) || "[]");
    renderKanban(cards);
  }
};

document.getElementById("btnAddLead").onclick = () => {
  const title = leadTitle.value.trim();
  if (!title) return;
  const newCard = { title, col: "novo", ts: Date.now() };
  if (fb.ok) {
    db.collection("users").doc(getUID()).get().then(doc => {
      const cards = doc.data() && doc.data().kanban || [];
      cards.push(newCard);
      db.collection("users").doc(getUID()).update({ kanban: cards });
    });
  } else {
    const key = "px_kanban_" + getUID();
    const cards = JSON.parse(localStorage.getItem(key) || "[]");
    cards.push(newCard);
    localStorage.setItem(key, JSON.stringify(cards));
    renderKanban(cards);
  }
  leadTitle.value = "";
};

kb.addEventListener("dragstart", (e) => {
  if (e.target.classList.contains("kb-card")) {
    e.dataTransfer.setData("text/plain", e.target.dataset.id);
  }
});

kb.querySelectorAll(".kb-col").forEach(col => {
  col.addEventListener("dragover", (e) => e.preventDefault());
  col.addEventListener("drop", (e) => {
    e.preventDefault();
    const id = e.dataTransfer.getData("text/plain");
    const card = kb.querySelector(`.kb-card[data-id="${id}"]`);
    if (card) {
      col.querySelector(".kb-list").appendChild(card);
      card.dataset.col = col.dataset.col;
      saveKanban();
    }
  });
});

// WhatsApp
const waLog = document.getElementById("waLog");
const waStatus = document.getElementById("waStatus");

const walog = (s) => {
  const d = document.createElement("div");
  d.textContent = `[${new Date().toLocaleTimeString()}] ${s}`;
  waLog.prepend(d);
};

const setWABadge = (state) => {
  if (state === "connected") {
    waStatus.className = "badge b-ok";
    waStatus.textContent = "✅ Conectado";
  } else if (state === "error") {
    waStatus.className = "badge b-warn";
    waStatus.textContent = "⚠️ Erro";
  } else {
    waStatus.className = "badge b-warn";
    waStatus.textContent = "⏺ Desconectado";
  }
};

const waFetch = async (endpoint, method = 'GET') => {
  try {
    const response = await fetch(`/api/wa${endpoint}`, { method });
    walog(`${method} /api/wa${endpoint} → Status: ${response.status}`);
    return response;
  } catch (error) {
    walog(`Erro na requisição para ${endpoint}: ${error.message}`);
    setWABadge("error");
    return null;
  }
};

const refreshWA = async () => {
  const r = await waFetch(`/status?session=pixelup`);
  if (!r || !r.ok) {
    setWABadge("error");
    return false;
  }
  const j = await r.json();
  setWABadge(j.connected ? "connected" : "");
  return j.connected;
};

const connectShowQR = async () => {
  setWABadge("connecting");
  walog("Iniciando conexão... Aguardando QR Code.");
  const startResponse = await waFetch(`/start?session=pixelup`, 'POST');
  if (!startResponse || !startResponse.ok) {
    walog("Falha ao iniciar a sessão.");
    return;
  }

  const box = document.getElementById("qrBox");
  box.innerHTML = `<div class="muted">Carregando QR Code...</div>`;

  const checkQR = async () => {
    const qrResponse = await waFetch(`/qr?session=pixelup`);
    if (!qrResponse || qrResponse.status === 204) {
      walog("QR Code não disponível ou já conectado.");
      return true;
    }
    if (!qrResponse.ok) {
      box.innerHTML = `<div class="muted">Erro ao obter QR Code. Tente novamente.</div>`;
      return true;
    }
    const data = await qrResponse.json();
    if (data.qr) {
      box.innerHTML = `<img class="qrimg" src="${data.qr}">`;
      walog("QR Code recebido. Por favor, escaneie com seu celular.");
    }
    return false;
  };

  const statusCheckInterval = setInterval(async () => {
    const connected = await refreshWA();
    if (connected) {
      clearInterval(statusCheckInterval);
      box.innerHTML = `<div class="muted">✅ Dispositivo conectado.</div>`;
      walog("Dispositivo conectado com sucesso!");
    } else {
      await checkQR();
    }
  }, 3000);

  setTimeout(() => {
    clearInterval(statusCheckInterval);
    walog("Tempo limite para conexão atingido. Tente novamente.");
  }, 60000);
};

document.getElementById("waConnect").onclick = connectShowQR;
document.getElementById("waStatusBtn").onclick = refreshWA;

refreshWA();
</script>
</body>
</html>
