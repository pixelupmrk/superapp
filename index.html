<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>PixelUp SuperApp — V7 PixelUp</title>
  <meta name="description" content="CRM + WhatsApp + IA (Gemini) + Mentoria + Bootcamp"/>
  <meta name="theme-color" content="#0b1a2a"/>
  <link rel="preconnect" href="https://generativelanguage.googleapis.com" crossorigin>
  <style>
    :root{ --bg:#0b1118; --panel:#0f1b2a; --muted:#9bb3c7; --primary:#12b0ff; --primary2:#66d1ff; --accent:#00ffd5;
           --danger:#ff5d5d; --ok:#27c93f; --card:#0e1825; --border:#122235; --radius:16px; --shadow:0 8px 28px rgba(0,0,0,.35); }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:radial-gradient(1000px 600px at 10% -10%, rgba(18,176,255,.14), transparent 60%),
                 radial-gradient(800px 500px at 110% 10%, rgba(0,255,213,.10), transparent 60%), var(--bg);
      color:#eaf6ff;}
    a{color:var(--primary)} small.muted, .muted{color:#9bb3c7}
    header.topbar{position:sticky;top:0;z-index:20;display:flex;gap:16px;align-items:center;justify-content:space-between;
      padding:10px 14px;background:rgba(11,20,32,.8);border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
    .brand{display:flex;align-items:center;gap:10px;font-weight:700}
    .brand img{height:40px;display:block}
    nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
    nav.tabs button{background:#0b1522;color:#cfeaff;border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer}
    nav.tabs button.active{border-color:var(--primary);color:#fff;box-shadow:0 0 0 1px rgba(18,176,255,.25) inset}
    main{max-width:1400px;margin:20px auto;padding:0 16px}
    section.panel{display:none;background:rgba(15,27,42,.6);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:18px}
    section.panel.active{display:block}
    .grid{display:grid;gap:16px}
    .g-3{grid-template-columns:260px 1.2fr 0.9fr}
    .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--primary),var(--primary2));
      color:#001726;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 10px 22px rgba(0,0,0,.35),0 2px 0 rgba(0,0,0,.2) inset}
    .btn.secondary{background:#0b1522;color:#dff2ff;border:1px solid var(--border);box-shadow:none}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0c1725;color:#eaf6ff}
    .ws-dot{width:10px;height:10px;border-radius:50%;background:#666}.ws-dot.on{background:var(--ok)}.ws-dot.off{background:var(--danger)}
    .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
    .list{overflow:auto;max-height:60vh}
    .thread{overflow:auto;max-height:60vh;padding:12px;background:#0b1522;border-radius:12px;border:1px solid var(--border)}
    .msg{margin:8px 0;padding:8px 10px;border-radius:10px;border:1px solid var(--border)} .msg.me{background:#062438} .msg.them{background:#112234}
    footer{color:#7fa6c2;text-align:center;padding:28px 12px}
    @media (max-width:1100px){ .g-3{grid-template-columns:1fr} .thread,.list{max-height:none} }
    .tiny{font-size:12px}
    .tag{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;margin-right:6px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="./logo.jpg" alt="PixelUp logo" />
      <span>PixelUp SuperApp</span>
    </div>
    <nav class="tabs" id="tabs">
      <button data-tab="home" class="active">Home</button>
      <button data-tab="crm">CRM + WhatsApp</button>
      <button data-tab="mentoria">Mentoria (8 módulos)</button>
      <button data-tab="bootcamp">Chat do Bootcamp</button>
    </nav>
    <div class="row">
      <span class="ws-dot off" id="waDot"></span><span id="waLabel" class="muted">WA: off</span>
      <span class="pill" id="sseBadge">SSE: —</span>
      <span class="pill" id="botBadge">Bot: OFF</span>
      <button class="btn secondary" id="toggleBot">Autopiloto</button>
    </div>
  </header>

  <main>
    <!-- HOME -->
    <section class="panel active" id="panel-home">
      <div class="grid g-2">
        <div class="card">
          <h2>Hub PixelUp</h2>
          <p class="muted">Estilo Como CRM, mas com a cara PixelUp: WhatsApp conectado, CRM automático e IA (Gemini). Quando o <b>Autopiloto</b> está ligado, o bot atende, capta dados (nome, necessidade, prazo, orçamento), <b>salva</b> no CRM e pode <b>agendar</b>.</p>
          <div class="row">
            <button class="btn" data-goto="crm">Abrir CRM</button>
            <button class="btn secondary" data-goto="mentoria">Mentoria</button>
            <button class="btn secondary" data-goto="bootcamp">Bootcamp</button>
          </div>
        </div>
        <div class="card">
          <h3>Configurações rápidas</h3>
          <div class="row">
            <input class="input" id="myNumber" placeholder="Seu número WA (55DDDNUMERO)">
            <button class="btn secondary" id="saveNumber">Salvar</button>
          </div>
          <small class="muted">Evita o bot responder seu próprio número.</small>
          <div style="margin-top:12px">
            <label class="muted" for="aiKey">Gemini API Key</label>
            <input class="input" id="aiKey" placeholder="Cole sua chave do Gemini ou use ?gemini=SUA_KEY na URL">
            <button class="btn secondary" id="saveKey" style="margin-top:8px">Salvar Key</button>
            <div class="tiny muted" id="keyStatus">Key: —</div>
          </div>
        </div>
        <div class="card">
          <h3>Status do backend</h3>
          <div class="row">
            <span class="pill" id="waStatusText">off</span>
            <button class="btn secondary" id="btnCheckWA">Verificar</button>
          </div>
          <div id="diag" class="tiny" style="margin-top:8px"></div>
        </div>
      </div>
    </section>

    <!-- CRM + CHAT (Como-like: 3 colunas) -->
    <section class="panel" id="panel-crm">
      <div class="grid g-3">
        <!-- Contatos -->
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 style="margin:0">Contatos</h3>
            <button class="btn secondary tiny" id="exportCSV">Exportar CSV</button>
          </div>
          <div class="row" style="margin-top:8px">
            <input class="input" id="search" placeholder="Buscar por nome/telefone">
            <button class="btn secondary" id="clearSearch">Limpar</button>
          </div>
          <div class="list" id="contactsList"></div>
          <div class="card" style="margin-top:12px">
            <h4>Novo contato</h4>
            <input class="input" id="cName" placeholder="Nome (opcional)">
            <input class="input" id="cPhone" placeholder="Telefone (WhatsApp)">
            <textarea class="input" id="cNotes" placeholder="Notas"></textarea>
            <button class="btn" id="btnAdd">Adicionar</button>
          </div>
        </div>

        <!-- Conversa -->
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 id="threadTitle" style="margin:0">Conversa</h3>
            <div class="row tiny">
              <span class="tag" id="leadStageTag">Etapa: —</span>
              <span class="tag" id="leadOwnerTag">Responsável: —</span>
            </div>
          </div>
          <div class="thread" id="thread"></div>
          <div class="row" style="margin-top:8px">
            <input class="input" id="msgText" placeholder="Escreva uma mensagem">
            <button class="btn" id="sendMsg">Enviar</button>
          </div>
        </div>

        <!-- Ficha do Lead + Agenda -->
        <div class="card">
          <h3>Ficha do Lead</h3>
          <div class="grid g-2">
            <div>
              <label class="tiny muted">Nome</label>
              <input class="input" id="leadName" placeholder="—">
            </div>
            <div>
              <label class="tiny muted">Telefone</label>
              <input class="input" id="leadPhone" placeholder="—" disabled>
            </div>
            <div>
              <label class="tiny muted">Etapa</label>
              <select class="input" id="leadStage">
                <option>Lead</option><option>Qualificando</option><option>Proposta</option><option>Fechou</option><option>Perdido</option>
              </select>
            </div>
            <div>
              <label class="tiny muted">Responsável</label>
              <input class="input" id="leadOwner" placeholder="Ex.: PixelUp">
            </div>
            <div style="grid-column:1/-1">
              <label class="tiny muted">Tags</label>
              <input class="input" id="leadTags" placeholder="ex.: veículo, orçamento-baixo">
            </div>
            <div style="grid-column:1/-1">
              <label class="tiny muted">Notas</label>
              <textarea class="input" id="leadNotes" rows="3" placeholder="Resumo, objeções, próximos passos"></textarea>
            </div>
            <div style="grid-column:1/-1" class="row">
              <button class="btn secondary" id="saveLead">Salvar ficha</button>
              <button class="btn secondary" id="clearLead">Limpar</button>
            </div>
          </div>

          <hr style="border-color:#13253a;margin:16px 0"/>
          <h3>Agenda</h3>
          <div class="grid g-2">
            <div>
              <label class="tiny muted">Data</label>
              <input class="input" id="agDate" type="date">
            </div>
            <div>
              <label class="tiny muted">Hora</label>
              <input class="input" id="agTime" type="time">
            </div>
            <div style="grid-column:1/-1">
              <label class="tiny muted">Descrição</label>
              <input class="input" id="agDesc" placeholder="Ex.: Apresentar proposta">
            </div>
            <div style="grid-column:1/-1" class="row">
              <button class="btn" id="agendarBtn">Agendar e confirmar no WhatsApp</button>
            </div>
          </div>
          <div style="margin-top:12px">
            <h4 class="tiny muted" style="margin:0 0 6px">Próximos compromissos</h4>
            <div id="agendaList" class="list" style="max-height:30vh"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- MENTORIA -->
    <section class="panel" id="panel-mentoria">
      <div class="grid g-2">
        <div class="card">
          <h3>Módulos</h3>
          <div id="modulesList"></div>
        </div>
        <div class="card">
          <h3 id="lessonTitle">Selecione um módulo</h3>
          <div id="lessonBody" class="muted">O conteúdo aparecerá aqui.</div>
        </div>
      </div>
    </section>

    <!-- BOOTCAMP -->
    <section class="panel" id="panel-bootcamp">
      <div class="grid g-2">
        <div class="card">
          <h3>Chat do Bootcamp (IA)</h3>
          <p class="muted">Tira-dúvidas com o Gemini (não envia ao WhatsApp).</p>
          <textarea class="input" id="bootQ" rows="4" placeholder="Digite sua dúvida..."></textarea>
          <div class="row" style="margin-top:8px">
            <button class="btn" id="bootAsk">Perguntar</button>
          </div>
        </div>
        <div class="card">
          <h3>Resposta</h3>
          <div id="bootA" class="thread"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Mentoria (8) inline -->
  <script id="mentoria-data" type="application/json">{
    "modules":[
      {"id":"m1","title":"Módulo 1 — Persona e Fundamentos do Negócio","lessons":[
        {"id":"m1l1","title":"Definição de Persona","content":"# Persona\nDescreva claramente seu cliente ideal.\n- Dor principal\n- Desejos e objeções\n- Linguagem e canais preferidos"},
        {"id":"m1l2","title":"Proposta de Valor","content":"**O que torna sua oferta única?** Liste benefícios tangíveis e intangíveis."}
      ]},
      {"id":"m2","title":"Módulo 2 — Algoritmo do Meta (Facebook/Instagram)","lessons":[
        {"id":"m2l1","title":"Como o algoritmo decide a entrega","content":"Sinais: engajamento, retenção, tempo de sessão, relevância."},
        {"id":"m2l2","title":"Boas práticas de conteúdo","content":"- Gatilhos de parada\n- CTAs claros\n- Testes A/B"}
      ]},
      {"id":"m3","title":"Módulo 3 — Cronograma e Calendário Editorial","lessons":[
        {"id":"m3l1","title":"Estrutura de calendário","content":"Organize posts por tema, formato e objetivo."},
        {"id":"m3l2","title":"Métricas de consistência","content":"Taxa de publicação, frequência mínima, cadência."}
      ]},
      {"id":"m4","title":"Módulo 4 — Conteúdo Visual (vídeo e imagem)","lessons":[
        {"id":"m4l1","title":"Roteiro e captação","content":"Storyboard, **hook** em 3s, cortes dinâmicos."},
        {"id":"m4l2","title":"Design que converte","content":"Contraste, tipografia, hierarquia e *branding*."}
      ]},
      {"id":"m5","title":"Módulo 5 — Copy com IA (ChatGPT)","lessons":[
        {"id":"m5l1","title":"Prompt base","content":"Estrutura com objetivo, público, tom e formato."},
        {"id":"m5l2","title":"Ajustes finos","content":"Refine com exemplos e *few-shot*."}
      ]},
      {"id":"m6","title":"Módulo 6 — CRM e Organização Comercial","lessons":[
        {"id":"m6l1","title":"Pipeline simples","content":"Kanban: Lead → Qualificando → Proposta → Fechou."},
        {"id":"m6l2","title":"Follow-up e rotinas","content":"Sequências e lembretes."}
      ]},
      {"id":"m7","title":"Módulo 7 — Técnicas de Vendas (rapport e conexão)","lessons":[
        {"id":"m7l1","title":"Rapport prático","content":"*Espelhamento*, *escuta ativa*, perguntas abertas."},
        {"id":"m7l2","title":"Fechamento","content":"Tratamento de objeções e *closing* sem pressão."}
      ]},
      {"id":"m8","title":"Módulo 8 — Implementação de CRM + Tráfego Pago","lessons":[
        {"id":"m8l1","title":"Integração com WhatsApp","content":"Conectar bot, gatilhos automáticos, registrar interações."},
        {"id":"m8l2","title":"Playbook de campanhas","content":"Estruturas por objetivo e orçamento inicial."}
      ]}
    ]
  }</script>

  <script>
  // ===== Config =====
  window.PIXELUP = {
    WA_BASE: "/api",                               // via proxy (vercel.json) → Replit
    GEMINI_MODEL: "gemini-2.0-flash",
    REPLIT_DIRECT: "https://pixelup-wa-server.pixelupmrkt.repl.co"                    // diagnóstico extra
  };

  // ===== Utils =====
  const $ = sel => document.querySelector(sel);
  const byId = id => document.getElementById(id);
  const escapeHtml = s => (s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
  const norm = p => (''+(p||'')).replace(/[^0-9]/g,'');
  const ls = { get(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)); } };
  const qparam = key => new URLSearchParams(location.search).get(key);

  // ===== State =====
  const state = {
    botOn: ls.get('px_bot_on', true),
    myNumber: ls.get('px_my_number', ''),
    aiKey: ls.get('px_ai_key', qparam('gemini') || ''),
    contacts: ls.get('px_contacts', {}),     // {phone:{phone,name,notes,lastText,lastTs,tags,stage,owner}}
    threads:  ls.get('px_threads', {}),      // phone => [{who,text,ts}]
    leads:    ls.get('px_leads', {}),        // phone => {stage,owner,tags,notes}
    agenda:   ls.get('px_agenda', []),       // [{phone,whenISO,desc,createdTs}]
    current: null,
    search: ''
  };

  // ===== UI refs =====
  const waDot = byId('waDot'), waLabel = byId('waLabel'), waStatusText = byId('waStatusText'), sseBadge = byId('sseBadge');
  const botBadge = byId('botBadge'), toggleBot = byId('toggleBot');
  const myNumber = byId('myNumber'), saveNumber = byId('saveNumber');
  const aiKey = byId('aiKey'), saveKey = byId('saveKey');
  const btnCheckWA = byId('btnCheckWA'), diag = byId('diag');
  const contactsList = byId('contactsList'), thread = byId('thread'), threadTitle = byId('threadTitle');
  const cName = byId('cName'), cPhone = byId('cPhone'), cNotes = byId('cNotes'), btnAdd = byId('btnAdd');
  const msgText = byId('msgText'), sendMsg = byId('sendMsg'), exportCSV = byId('exportCSV');
  const search = byId('search'), clearSearch = byId('clearSearch');
  // Lead panel
  const leadName = byId('leadName'), leadPhone = byId('leadPhone'), leadStage = byId('leadStage');
  const leadOwner = byId('leadOwner'), leadTags = byId('leadTags'), leadNotes = byId('leadNotes');
  const saveLead = byId('saveLead'), clearLead = byId('clearLead');
  const leadStageTag = byId('leadStageTag'), leadOwnerTag = byId('leadOwnerTag');
  // Agenda
  const agDate = byId('agDate'), agTime = byId('agTime'), agDesc = byId('agDesc'), agendarBtn = byId('agendarBtn'), agendaList = byId('agendaList');

  // ===== Init =====
  (function init(){
    myNumber.value = state.myNumber || '';
    aiKey.value = state.aiKey || '';
    botBadge.textContent = 'Autopiloto: ' + (state.botOn? 'ON':'OFF');
    toggleBot.textContent = state.botOn ? 'Desligar' : 'Ligar';
    byId('keyStatus').textContent = state.aiKey ? 'Key: carregada' : 'Key: vazia (use ?gemini=...)';
    renderContacts(); renderThread(null); renderAgenda();
    runDiagnostics();
  })();

  // ===== Tabs =====
  (function tabs(){
    const tabs = byId('tabs');
    const panels = { home: byId('panel-home'), crm: byId('panel-crm'), mentoria: byId('panel-mentoria'), bootcamp: byId('panel-bootcamp') };
    tabs.addEventListener('click', (e)=>{
      if(e.target.tagName!=='BUTTON') return;
      const tab = e.target.dataset.tab;
      tabs.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
      Object.keys(panels).forEach(k=>panels[k].classList.toggle('active', k===tab));
    });
    document.querySelectorAll('[data-goto]').forEach(btn=>btn.addEventListener('click', ()=>{
      const tab = btn.dataset.goto;
      tabs.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b.dataset.tab===tab));
      Object.values(panels).forEach(p=>p.classList.remove('active'));
      panels[tab].classList.add('active');
    }));
  })();

  // ===== Buttons =====
  toggleBot.addEventListener('click', ()=>{ state.botOn = !state.botOn; ls.set('px_bot_on', state.botOn);
    botBadge.textContent = 'Autopiloto: ' + (state.botOn? 'ON':'OFF'); toggleBot.textContent = state.botOn ? 'Desligar' : 'Ligar'; });
  saveNumber.addEventListener('click', ()=>{ state.myNumber = myNumber.value.trim(); ls.set('px_my_number', state.myNumber); alert('Número salvo'); });
  saveKey.addEventListener('click', ()=>{ state.aiKey = aiKey.value.trim(); ls.set('px_ai_key', state.aiKey); alert(state.aiKey?'Key salva':'Sem key'); byId('keyStatus').textContent = state.aiKey?'Key: carregada':'Key: vazia'; });
  btnCheckWA.addEventListener('click', waStatus);

  clearLead.addEventListener('click', ()=>{ if(!state.current) return; const p = state.current; delete state.leads[p]; ls.set('px_leads', state.leads); loadLead(p); renderContacts(); });
  saveLead.addEventListener('click', ()=>{
    if(!state.current) return; const p = state.current;
    state.leads[p] = {
      stage: leadStage.value || 'Lead',
      owner: leadOwner.value || '',
      tags: (leadTags.value||'').split(',').map(s=>s.trim()).filter(Boolean),
      notes: leadNotes.value || ''
    };
    if(state.contacts[p]){ state.contacts[p].name = leadName.value || state.contacts[p].name; state.contacts[p].notes = state.leads[p].notes; }
    ls.set('px_leads', state.leads); ls.set('px_contacts', state.contacts);
    renderContacts(); loadLead(p);
  });

  // ===== CRM rendering =====
  exportCSV.addEventListener('click', ()=>{
    const rows = [['Telefone','Nome','Etapa','Responsável','Tags','Notas','Última mensagem','Atualizado em']];
    Object.values(state.contacts).forEach(c=>{
      const L = state.leads[c.phone] || {};
      rows.push([c.phone, c.name||'', L.stage||'', L.owner||'', (L.tags||[]).join('|'), L.notes||'', c.lastText||'', new Date(c.lastTs||0).toISOString()]);
    });
    const csv = rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download = 'contatos.csv'; a.click();
  });

  function renderContacts(){
    contactsList.innerHTML = '';
    let arr = Object.values(state.contacts);
    if(state.search){ const q = state.search.toLowerCase();
      arr = arr.filter(c => (c.name||'').toLowerCase().includes(q) || (c.phone||'').includes(q)); }
    arr.sort((a,b)=> (b.lastTs||0)-(a.lastTs||0));
    if(arr.length===0){ contactsList.innerHTML = '<p class="muted">Sem contatos ainda.</p>'; return; }
    for(const c of arr){
      const L = state.leads[c.phone] || {};
      const div = document.createElement('div'); div.className='msg';
      div.innerHTML = `<strong>${escapeHtml(c.name||c.phone)}</strong><br>
      <small class="muted">${escapeHtml(c.phone)} — ${escapeHtml(c.lastText||'')}</small><br>
      <small class="muted">Etapa: ${escapeHtml(L.stage||'Lead')} • Resp.: ${escapeHtml(L.owner||'-')}</small>`;
      div.onclick = ()=>{ state.current = c.phone; renderThread(c.phone); loadLead(c.phone); };
      contactsList.appendChild(div);
    }
  }
  function renderThread(phone){
    thread.innerHTML = '';
    if(!phone){ threadTitle.textContent = 'Conversa'; leadStageTag.textContent='Etapa: —'; leadOwnerTag.textContent='Responsável: —'; return; }
    threadTitle.textContent = 'Conversa — ' + phone;
    (state.threads[phone]||[]).forEach(m => {
      const div = document.createElement('div'); div.className='msg '+(m.who==='me'?'me':'them');
      const date = new Date(m.ts||Date.now()).toLocaleString();
      div.innerHTML = `<small class="muted">${date}</small><br>${escapeHtml(m.text||'')}`;
      thread.appendChild(div);
    });
    thread.scrollTop = thread.scrollHeight;
  }
  function upsertContact(phone, data, lastText, ts){
    const c = state.contacts[phone] || {phone};
    state.contacts[phone] = { ...c, ...data, lastText, lastTs: ts };
    ls.set('px_contacts', state.contacts);
    renderContacts();
  }
  function pushMsg(phone, m){
    const arr = state.threads[phone] || []; arr.push(m); state.threads[phone] = arr; ls.set('px_threads', state.threads);
  }
  function loadLead(phone){
    leadPhone.value = phone || '';
    const c = state.contacts[phone] || {}; leadName.value = c.name||'';
    const L = state.leads[phone] || {stage:'Lead',owner:'',tags:[],notes:''};
    leadStage.value = L.stage || 'Lead'; leadOwner.value = L.owner || '';
    leadTags.value = (L.tags||[]).join(', '); leadNotes.value = L.notes || '';
    leadStageTag.textContent = 'Etapa: ' + (L.stage || 'Lead');
    leadOwnerTag.textContent = 'Responsável: ' + (L.owner || '—');
  }

  // Inputs
  search.addEventListener('input', ()=>{ state.search = search.value; renderContacts(); });
  clearSearch.addEventListener('click', ()=>{ state.search=''; search.value=''; renderContacts(); });
  btnAdd.addEventListener('click', ()=>{
    const phone = norm(cPhone.value.trim()); if(!phone) return;
    upsertContact(phone, {phone, name: cName.value.trim()||phone, notes: cNotes.value.trim()}, '', Date.now());
    cName.value = cPhone.value = cNotes.value = '';
  });
  sendMsg.addEventListener('click', async ()=>{
    const phone = state.current; const text = msgText.value.trim(); if(!phone || !text) return;
    await waSend({to: phone, text}); pushMsg(phone, {who:'me', text, ts: Date.now()}); msgText.value=''; renderThread(phone);
  });

  // ===== Agenda =====
  function renderAgenda(){
    agendaList.innerHTML = '';
    const items = [...state.agenda].sort((a,b)=> (a.whenISO>b.whenISO?1:-1));
    if(items.length===0){ agendaList.innerHTML = '<p class="muted tiny">Sem compromissos.</p>'; return; }
    for(const it of items){
      const c = state.contacts[it.phone] || {name: it.phone};
      const row = document.createElement('div'); row.className='msg';
      row.innerHTML = `<b>${escapeHtml(c.name||it.phone)}</b><br>
        <small class="muted">${new Date(it.whenISO).toLocaleString()} — ${escapeHtml(it.desc||'')}</small>`;
      agendaList.appendChild(row);
    }
  }
  agendarBtn.addEventListener('click', async ()=>{
    if(!state.current) return;
    const d = agDate.value, t = agTime.value, desc = agDesc.value.trim()||'Atendimento PixelUp';
    if(!d || !t) return alert('Defina data e hora');
    const whenISO = new Date(`${d}T${t}:00`).toISOString();
    state.agenda.push({ phone: state.current, whenISO, desc, createdTs: Date.now() });
    ls.set('px_agenda', state.agenda); renderAgenda();
    const msg = `Perfeito! Agendei: ${new Date(whenISO).toLocaleString()} — ${desc}. Qualquer ajuste me avise.`;
    await waSend({to: state.current, text: msg});
    pushMsg(state.current, {who:'me', text: msg, ts: Date.now()}); renderThread(state.current);
    agDesc.value=''; // mantém data/hora
  });

  // ===== WhatsApp backend (via /api proxy) =====
  async function waStatus(){
    try{
      const r = await fetch(window.PIXELUP.WA_BASE + '/status');
      const j = await r.json();
      const ok = !!j.connected;
      waDot.classList.toggle('on', ok); waDot.classList.toggle('off', !ok);
      waLabel.textContent = ok ? ('WA: on' + (j.user?' ('+j.user+')':'')) : 'WA: off';
      waStatusText.textContent = ok ? 'on' : 'off';
      return ok;
    }catch(e){ waDot.classList.remove('on'); waDot.classList.add('off'); waStatusText.textContent='off'; return false; }
  }
  async function waSend({to, text}){
    const r = await fetch(window.PIXELUP.WA_BASE + '/send', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to, text}) });
    try{ return await r.json(); }catch{ return {ok:false}; }
  }
  function waEvents(){
    let es = null, timer = null;
    const open = ()=>{
      try{
        if(es) es.close();
        es = new EventSource(window.PIXELUP.WA_BASE + '/events');
        es.onopen = ()=>{ sseBadge.textContent='SSE: ON'; sseBadge.style.color='#b5ffd0'; };
        es.onmessage = async ev => {
          try{
            const data = JSON.parse(ev.data);
            if(data.type==='status'){ await waStatus(); }
            if(data.type==='message'){
              const phone = norm(data.from||''); if(!phone) return;
              upsertContact(phone, {phone, name: data.name||phone, notes:''}, data.text||'', data.ts||Date.now());
              pushMsg(phone, {who:'them', text: data.text||'', ts: data.ts||Date.now()});
              if(state.current===phone) renderThread(phone);

              // Auto captura com IA (somente primeira mensagem ou quando sem ficha)
              const needCapture = !state.leads[phone] || !(state.leads[phone].notes);
              if(state.botOn && phone !== norm(state.myNumber)){
                if(needCapture){
                  const info = await geminiCapture(`Mensagem do cliente: "${data.text||''}". Extraia em JSON: nome (se houver), assunto/necessidade, orçamento estimado (se citar), prazo/urgência (se citar) e uma sugestão de etapa (Lead/Qualificando/Proposta). Resposta curta.`);
                  if(info){
                    // Atualiza ficha
                    const L = state.leads[phone] || {};
                    state.leads[phone] = {
                      stage: info.etapa || L.stage || 'Lead',
                      owner: L.owner || '',
                      tags: L.tags || [],
                      notes: [info.nome?`Nome: ${info.nome}`:'', info.assunto?`Assunto: ${info.assunto}`:'', info.orcamento?`Orçamento: ${info.orcamento}`:'', info.prazo?`Prazo: ${info.prazo}`:''].filter(Boolean).join(' | ')
                    };
                    if(state.contacts[phone]){
                      state.contacts[phone].name = state.contacts[phone].name || info.nome || phone;
                      state.contacts[phone].notes = state.leads[phone].notes;
                      ls.set('px_contacts', state.contacts);
                    }
                    ls.set('px_leads', state.leads);
                    if(state.current===phone) loadLead(phone);
                  }
                }
                // Resposta automática
                const reply = await geminiReply("Você é um atendente virtual da PixelUp. Responda de forma educada, objetiva e peça dados essenciais (nome, necessidade, orçamento, prazo). Se o assunto for veículos, pergunte modelo/ano/valor. Se o contato pedir humano, diga que vai acionar o atendimento.\n\nPergunta do cliente: " + (data.text||''));
                if(reply){ await waSend({to: phone, text: reply}); pushMsg(phone, {who:'me', text: reply, ts: Date.now()}); if(state.current===phone) renderThread(phone); }
              }
            }
          }catch{}
        };
        es.onerror = ()=>{ sseBadge.textContent='SSE: OFF'; sseBadge.style.color='#ffd0d0'; timer && clearTimeout(timer); timer = setTimeout(open, 3000); };
      }catch(e){ sseBadge.textContent='SSE: OFF'; sseBadge.style.color='#ffd0d0'; timer && clearTimeout(timer); timer = setTimeout(open, 3000); }
    };
    open();
  }
  waStatus(); waEvents();

  // ===== Gemini (IA) =====
  const GEM_MODEL = window.PIXELUP.GEMINI_MODEL;
  function getKey(){ return (state.aiKey||'').trim(); }
  async function geminiReply(prompt){
    const key = getKey(); if(!key) return '';
    try{
      const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEM_MODEL}:generateContent`, {
        method:'POST', headers:{'Content-Type':'application/json','x-goog-api-key': key},
        body: JSON.stringify({ contents:[{ parts:[ {text: prompt} ] }]})
      });
      const j = await r.json();
      return (j?.candidates?.[0]?.content?.parts?.[0]?.text || '').trim();
    }catch(e){ return ''; }
  }
  async function geminiCapture(prompt){
    const key = getKey(); if(!key) return null;
    const body = {
      contents: [{ parts: [ {text: prompt} ] }],
      generationConfig: { response_mime_type: "application/json" }
    };
    try{
      const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEM_MODEL}:generateContent`, {
        method:'POST', headers:{'Content-Type':'application/json','x-goog-api-key': key}, body: JSON.stringify(body)
      });
      const j = await r.json();
      const t = j?.candidates?.[0]?.content?.parts?.[0]?.text || "";
      try{ return JSON.parse(t); }catch{ return null; }
    }catch(e){ return null; }
  }

  // Bootcamp Chat
  function appendBoot(who, text){
    const div = document.createElement('div'); div.className = 'msg ' + (who==='Você' ? 'me' : 'them');
    const date = new Date().toLocaleString();
    div.innerHTML = `<small class="muted">${date} — <b>${who}</b></small><br>${escapeHtml(text)}`;
    byId('bootA').appendChild(div); byId('bootA').scrollTop = byId('bootA').scrollHeight;
  }
  byId('bootAsk').addEventListener('click', async ()=>{
    const q = byId('bootQ').value.trim(); if(!q) return; appendBoot('Você', q); byId('bootQ').value='';
    const a = await geminiReply("Você é um tutor do Bootcamp PixelUp. Responda de forma clara e objetiva. Pergunta: " + q);
    appendBoot('Tutor', a || '(sem resposta)');
  });

  // Diagnóstico
  async function runDiagnostics(){
    const lines = [];
    lines.push(`<div>Origin: <code>${escapeHtml(location.origin)}</code></div>`);
    try{ const r = await fetch('/api/status'); const ok = r.ok; const j = ok? await r.json():{}; lines.push(`<div>/api/status: <b>${ok?'OK':'FAIL'}</b> ${ok?escapeHtml(JSON.stringify(j)):''}</div>`);}catch{ lines.push(`<div>/api/status: <b>FAIL</b></div>`); }
    if(!(state.aiKey||'').trim()){
      try{ const r2 = await fetch('/api/gemini', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({prompt:'ping'})}); const ok2 = r2.ok; const j2 = ok2? await r2.json():{}; lines.push(`<div>/api/gemini: <b>${ok2?'OK':'FAIL'}</b> ${ok2?escapeHtml(JSON.stringify(j2)):''}</div>`);}catch{ lines.push(`<div>/api/gemini: <b>FAIL</b></div>`); }
    }
    try{ const r3 = await fetch(window.PIXELUP.REPLIT_DIRECT + '/status'); const ok3 = r3.ok; const j3 = ok3? await r3.json():{}; lines.push(`<div>Direto Replit /status: <b>${ok3?'OK':'FAIL'}</b> ${ok3?escapeHtml(JSON.stringify(j3)):''}</div>`);}catch{ lines.push(`<div>Direto Replit /status: <b>FAIL</b></div>`); }
    byId('diag').innerHTML = lines.join('');
  }
  </script>

  <footer>© PixelUp — SuperApp V7 PixelUp</footer>
</body>
</html>
