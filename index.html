<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PixelUp SuperApp — Classic</title>
<meta name="theme-color" content="#0b1a2a"/>

<!-- Se quiser fixar a key do Gemini via Vercel (build): preencha esta meta -->
<meta name="x-gemini" content="">

<link rel="preconnect" href="https://generativelanguage.googleapis.com" crossorigin>
<script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>
<style>
  :root{
    --bg:#0b1118; --panel:#0f1b2a; --muted:#9bb3c7; --primary:#12b0ff; --primary2:#66d1ff; --accent:#00ffd5;
    --danger:#ff5d5d; --ok:#27c93f; --card:#0e1825; --border:#122235; --radius:16px; --shadow:0 8px 28px rgba(0,0,0,.35);
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    background:radial-gradient(1000px 600px at 10% -10%, rgba(18,176,255,.14), transparent 60%),
               radial-gradient(800px 500px at 110% 10%, rgba(0,255,213,.10), transparent 60%), var(--bg); color:#eaf6ff;}
  a{color:var(--primary)} .muted{color:#9bb3c7} .tiny{font-size:12px} .pill{padding:4px 8px;border-radius:999px;border:1px solid var(--border)}
  header.topbar{position:sticky;top:0;z-index:20;display:flex;gap:16px;align-items:center;justify-content:space-between;
    padding:12px 16px;background:rgba(11,20,32,.8);border-bottom:1px solid var(--border);backdrop-filter:blur(8px)}
  .brand{display:flex;align-items:center;gap:10px;font-weight:700}
  .brand img{height:36px;display:block}
  .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));
    box-shadow:0 0 12px rgba(18,176,255,.7),0 0 24px rgba(0,255,213,.5)}
  nav.tabs{display:flex;gap:8px;flex-wrap:wrap}
  nav.tabs button{background:#0b1522;color:#cfeaff;border:1px solid var(--border);padding:8px 12px;border-radius:999px;cursor:pointer}
  nav.tabs button.active{border-color:var(--primary);color:#fff;box-shadow:0 0 0 1px rgba(18,176,255,.25) inset}
  main{max-width:1250px;margin:24px auto;padding:0 16px}
  section.panel{display:none;background:rgba(15,27,42,.6);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;margin-bottom:18px}
  section.panel.active{display:block}
  .grid{display:grid;gap:16px} .g-3{grid-template-columns:repeat(3,minmax(0,1fr))} .g-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow)}
  .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(135deg,var(--primary),var(--primary2));
    color:#001726;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 10px 22px rgba(0,0,0,.35),0 2px 0 rgba(0,0,0,.2) inset}
  .btn.secondary{background:#0b1522;color:#dff2ff;border:1px solid var(--border);box-shadow:none}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input,textarea,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:#0c1725;color:#eaf6ff}
  .thread{overflow:auto;max-height:64vh;padding:12px;background:#0b1522;border-radius:12px;border:1px solid var(--border)}
  .msg{margin:8px 0;padding:8px 10px;border-radius:10px;border:1px solid var(--border)} .msg.me{background:#062438} .msg.them{background:#112234}
  /* Landing */
  .landing{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;padding:48px 16px}
  .landing img{width:160px;height:160px;border-radius:24px;object-fit:contain;background:#0b1522;border:1px solid var(--border)}
  .landing .actions{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  /* Kanban */
  .kanban{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  .col{background:#0b1522;border:1px solid var(--border);border-radius:14px;padding:10px;min-height:200px}
  .col h4{margin:6px 0 10px 0}
  .card-k{background:#0e1624;border:1px solid var(--border);border-radius:12px;padding:10px;margin-bottom:10px;cursor:grab;position:relative}
  .card-k .icons{position:absolute;right:8px;top:8px;display:flex;gap:6px}
  .card-k .icon{cursor:pointer}
  .card-k.drag{opacity:.6}
  .empty{color:#89a; font-style:italic}
  @media (max-width:1100px){ .kanban{grid-template-columns:1fr} .thread{max-height:unset}}
</style>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="./logo.jpg" alt="PixelUp" onerror="this.style.display='none'"/>
      <span><span class="dot"></span> PixelUp SuperApp</span>
    </div>
    <nav class="tabs" id="tabs">
      <button data-tab="home" class="active">Home</button>
      <button data-tab="crm">CRM</button>
      <button data-tab="mentoria">Mentoria</button>
      <button data-tab="config">Configurações</button>
    </nav>
  </header>

  <main>
    <!-- HOME (somente logo + botões grandes) -->
    <section class="panel active" id="panel-home">
      <div class="landing">
        <img src="./logo.jpg" alt="PixelUp" onerror="this.style.display='none'"/>
        <div class="actions">
          <button class="btn" data-goto="crm">Abrir CRM</button>
          <button class="btn secondary" data-goto="mentoria">Mentoria</button>
          <button class="btn secondary" data-goto="config">Configurações</button>
        </div>
      </div>
    </section>

    <!-- CRM -->
    <section class="panel" id="panel-crm">
      <!-- CONTATOS EM CIMA -->
      <div class="card">
        <h3>Cadastro rápido de contato</h3>
        <div class="grid g-3">
          <input class="input" id="cName" placeholder="Nome">
          <input class="input" id="cEmail" placeholder="E-mail">
          <input class="input" id="cPhone" placeholder="Telefone (WhatsApp)">
        </div>
        <div class="row" style="margin-top:8px">
          <select class="input" id="cOrigin">
            <option value="WhatsApp">Origem: WhatsApp</option>
            <option>Facebook</option><option>Instagram</option>
            <option>Site</option><option>Indicação</option><option>Outro</option>
          </select>
          <input class="input" id="cNotes" placeholder="Notas (opcional)">
          <button class="btn" id="btnAdd">Salvar contato</button>
          <input class="input" id="search" placeholder="Buscar (nome/telefone/e-mail/origem)" />
          <button class="btn secondary" id="clearSearch">Limpar</button>
        </div>
      </div>

      <div class="grid g-2" style="margin-top:12px">
        <!-- KANBAN -->
        <div class="card">
          <h3>Kanban</h3>
          <div class="kanban" id="kanban">
            <div class="col" data-stage="novo"><h4>Novos</h4><div class="empty tiny">— sem cards —</div></div>
            <div class="col" data-stage="qualificando"><h4>Qualificando</h4><div class="empty tiny">— sem cards —</div></div>
            <div class="col" data-stage="proposta"><h4>Proposta</h4><div class="empty tiny">— sem cards —</div></div>
            <div class="col" data-stage="fechado"><h4>Fechado</h4><div class="empty tiny">— sem cards —</div></div>
          </div>
        </div>

        <!-- CONVERSA -->
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <h3 id="threadTitle">Conversa — selecione um card</h3>
            <div class="row">
              <span class="pill" id="botBadge">Bot: OFF</span>
              <button class="btn secondary" id="toggleBot">Ligar IA</button>
              <a class="btn secondary" id="btnQR" target="_blank">Gerar QR</a>
              <span class="tiny muted" id="waStatusText">Status: —</span>
            </div>
          </div>
          <div class="thread" id="thread"></div>
          <div class="row" style="margin-top:8px">
            <input class="input" id="msgText" placeholder="Mensagem para enviar no WhatsApp">
            <button class="btn" id="sendMsg">Enviar</button>
          </div>
        </div>
      </div>

      <!-- DASHBOARD EMBAIXO -->
      <div class="card" style="margin-top:12px">
        <h3>Dashboard</h3>
        <div class="row">
          <div class="pill">Novos: <b id="mNovos">0</b></div>
          <div class="pill">Qualificando: <b id="mQuali">0</b></div>
          <div class="pill">Proposta: <b id="mProp">0</b></div>
          <div class="pill">Fechado: <b id="mFech">0</b></div>
        </div>
      </div>
    </section>

    <!-- MENTORIA -->
    <section class="panel" id="panel-mentoria">
      <div class="grid g-2">
        <div class="card">
          <h3>Módulos</h3>
          <div id="modulesList"></div>
          <hr style="border-color:#123">
          <div class="tiny muted">Importar conteúdo do Word (.docx) para o módulo selecionado:</div>
          <input type="file" id="docxInput" accept=".docx"/>
          <button class="btn secondary" id="importDocx">Importar .docx</button>
          <div class="tiny muted" style="margin-top:6px">
            Se você subir os arquivos <code>/mentoria/m1.docx</code> … <code>/mentoria/m8.docx</code> na Vercel,
            o sistema tenta carregar automaticamente.
          </div>
        </div>
        <div class="card">
          <h3 id="lessonTitle">Selecione um módulo</h3>
          <div id="lessonBody" class="muted">O conteúdo aparecerá aqui.</div>
        </div>
      </div>
    </section>

    <!-- CONFIGURAÇÕES (apenas nome do usuário) -->
    <section class="panel" id="panel-config">
      <div class="card">
        <h3>Configurações</h3>
        <div class="grid g-3">
          <input class="input" id="userName" placeholder="Seu nome (exibido no CRM)">
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="saveUser">Salvar</button>
        </div>
        <small class="muted">As demais configurações (WhatsApp/API) ficam fora da UI e serão tratadas no backend/deploy.</small>
      </div>
    </section>
  </main>

  <script>
  // ===== Config =====
  window.PIXELUP = {
    WA_BASE: "/api", // proxy via vercel.json
    GEMINI_MODEL: "gemini-2.0-flash",
    REPLIT_DIRECT: "https://pixelup-wa-server.pixelupmrkt.repl.co"
  };

  // ===== Utils & State =====
  const $ = s => document.querySelector(s); const byId = id => document.getElementById(id);
  const escapeHtml = s => (s||'').replace(/[&<>\"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#039;"}[m]));
  const norm = p => (''+(p||'')).replace(/[^0-9]/g,'');
  const ls = { get(k,d){ try{ return JSON.parse(localStorage.getItem(k)) ?? d; }catch{ return d; } }, set(k,v){ localStorage.setItem(k, JSON.stringify(v)); } };
  const qparam = k => new URLSearchParams(location.search).get(k);
  const metaGem = (document.querySelector('meta[name="x-gemini"]')?.content||'').trim();

  const stages = ["novo","qualificando","proposta","fechado"];
  const state = {
    userName: ls.get('px_user_name',''),
    aiKey: ls.get('px_ai_key', (qparam('gemini') || metaGem || '')),
    contacts: ls.get('px_contacts', {}),  // phone -> record
    threads:  ls.get('px_threads', {}),   // phone -> msgs[]
    botMap:   ls.get('px_bot_map', {}),   // phone -> true/false
    current: null,
    search: ''
  };

  // ===== Tabs =====
  (function initTabs(){
    const tabs = byId('tabs');
    const panels = {home: byId('panel-home'), crm: byId('panel-crm'), mentoria: byId('panel-mentoria'), config: byId('panel-config')};
    const activate = (tab) => {
      tabs.querySelectorAll('button').forEach(b => b.classList.toggle('active', b.dataset.tab===tab));
      Object.values(panels).forEach(p => p.classList.remove('active'));
      panels[tab].classList.add('active');
      if(tab==='crm'){ renderKanban(); renderThread(null); refreshCounters(); }
    };
    tabs.addEventListener('click', (e)=>{
      if(e.target.tagName!=='BUTTON') return;
      activate(e.target.dataset.tab);
    });
    document.querySelectorAll('[data-goto]').forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.goto)));
  })();

  // ===== CRM elements =====
  const cName = byId('cName'), cEmail = byId('cEmail'), cPhone = byId('cPhone'), cOrigin = byId('cOrigin'), cNotes = byId('cNotes');
  const btnAdd = byId('btnAdd'), search = byId('search'), clearSearch = byId('clearSearch');
  const kanban = byId('kanban'), thread = byId('thread'), threadTitle = byId('threadTitle');
  const msgText = byId('msgText'), sendMsg = byId('sendMsg');
  const botBadge = byId('botBadge'), toggleBot = byId('toggleBot'), btnQR = byId('btnQR'), waStatusText = byId('waStatusText');

  btnAdd.onclick = ()=>{
    const phone = norm(cPhone.value.trim());
    if(!phone){ alert('Telefone é obrigatório'); return; }
    const rec = state.contacts[phone] || {};
    state.contacts[phone] = {
      phone,
      name: (cName.value||'').trim() || phone,
      email: (cEmail.value||'').trim(),
      origin: (cOrigin.value||'WhatsApp'),
      notes: (cNotes.value||'').trim(),
      stage: rec.stage || 'novo',
      lastText: rec.lastText || '', lastTs: rec.lastTs || Date.now()
    };
    ls.set('px_contacts', state.contacts);
    cName.value=cEmail.value=cPhone.value=cNotes.value='';
    renderKanban(); refreshCounters();
  };

  search.oninput = ()=>{ state.search = search.value.toLowerCase(); renderKanban(); };
  clearSearch.onclick = ()=>{ search.value=''; state.search=''; renderKanban(); };

  sendMsg.onclick = async ()=>{
    const phone = state.current; const text = msgText.value.trim();
    if(!phone || !text) return;
    await waSend({to: phone, text});
    pushMsg(phone, {who:'me', text, ts: Date.now()});
    msgText.value=''; renderThread(phone);
    touchContact(phone, {lastText: text});
  };

  toggleBot.onclick = ()=>{
    const p = state.current; if(!p) return;
    state.botMap[p] = !state.botMap[p]; ls.set('px_bot_map', state.botMap);
    setBotBadge(p);
  };

  btnQR.href = window.PIXELUP.REPLIT_DIRECT + '/qr';

  function setBotBadge(phone){
    const on = !!state.botMap[phone];
    botBadge.textContent = 'Bot: ' + (on?'ON':'OFF');
    toggleBot.textContent = on ? 'Desligar IA' : 'Ligar IA';
  }

  // ===== Data helpers =====
  function contactFilter(c){
    if(!state.search) return true;
    const q = state.search;
    return [c.name,c.phone,c.email,c.origin,(c.notes||'')].join(' ').toLowerCase().includes(q);
  }
  function toCardHTML(c){
    return `
      <div class="card-k" draggable="true" data-phone="${c.phone}">
        <div class="icons">
          <span class="icon" title="Abrir conversa" data-action="open">💬</span>
          <span class="icon" title="Atualizar card" data-action="refresh">↻</span>
        </div>
        <b>${escapeHtml(c.name||c.phone)}</b><br>
        <span class="tiny muted">${escapeHtml(c.origin||'')}</span>
        ${c.email?`<div class="tiny muted">${escapeHtml(c.email)}</div>`:''}
        <div class="tiny muted">${escapeHtml(c.lastText||'')}</div>
      </div>`;
  }
  function renderKanban(){
    kanban.querySelectorAll('.col').forEach(col=>{
      const stage = col.dataset.stage;
      let html = '';
      const arr = Object.values(state.contacts).filter(c => (c.stage||'novo')===stage && contactFilter(c))
        .sort((a,b)=>(b.lastTs||0)-(a.lastTs||0));
      if(arr.length===0){ col.innerHTML = `<h4>${col.querySelector('h4').textContent}</h4><div class="empty tiny">— sem cards —</div>`; return; }
      html += `<h4>${col.querySelector('h4').textContent}</h4>`;
      html += arr.map(toCardHTML).join('');
      col.innerHTML = html;
    });
    initDragDrop();
    refreshCounters();
  }
  function initDragDrop(){
    let dragEl=null;
    kanban.querySelectorAll('.card-k').forEach(card=>{
      const phone = card.dataset.phone;
      card.addEventListener('dragstart',()=>{ dragEl=card; card.classList.add('drag'); });
      card.addEventListener('dragend',()=>{ card.classList.remove('drag'); dragEl=null; });
      // clique no corpo abre conversa
      card.addEventListener('click', (e)=>{ if(e.target.classList.contains('icon')) return; state.current = phone; renderThread(phone); setBotBadge(phone); });
      // ícones
      card.querySelectorAll('.icon').forEach(ic=>{
        ic.addEventListener('click', (e)=>{
          const action = ic.dataset.action;
          if(action==='open'){ state.current = phone; renderThread(phone); setBotBadge(phone); }
          if(action==='refresh'){ renderKanban(); }
          e.stopPropagation();
        });
      });
    });
    kanban.querySelectorAll('.col').forEach(col=>{
      col.addEventListener('dragover',e=>{ e.preventDefault(); });
      col.addEventListener('drop',e=>{
        e.preventDefault(); if(!dragEl) return;
        const phone = dragEl.dataset.phone; const stage = col.dataset.stage;
        const c = state.contacts[phone]; if(!c) return;
        c.stage = stage; state.contacts[phone]=c; ls.set('px_contacts', state.contacts);
        renderKanban();
      });
    });
  }
  function renderThread(phone){
    thread.innerHTML = '';
    if(!phone){ threadTitle.textContent = 'Conversa — selecione um card'; setBotBadge(null); return; }
    const c = state.contacts[phone] || {phone};
    const uname = state.userName ? ` • Atendente: ${escapeHtml(state.userName)}` : '';
    threadTitle.textContent = `Conversa — ${c.name||phone} (${phone})${uname}`;
    setBotBadge(phone);
    (state.threads[phone]||[]).forEach(m=>{
      const div=document.createElement('div'); div.className='msg '+(m.who==='me'?'me':'them');
      const date = new Date(m.ts||Date.now()).toLocaleString();
      div.innerHTML = `<small class="muted">${date}</small><br>${escapeHtml(m.text||'')}`;
      thread.appendChild(div);
    });
    thread.scrollTop = thread.scrollHeight;
  }
  function pushMsg(phone, m){
    const arr = state.threads[phone] || []; arr.push(m); state.threads[phone]=arr; ls.set('px_threads', state.threads);
  }
  function upsertContact(phone, patch){
    const c = state.contacts[phone] || {phone, stage:'novo', origin:'WhatsApp'};
    state.contacts[phone] = { ...c, ...patch };
    ls.set('px_contacts', state.contacts);
  }
  function touchContact(phone, patch){
    upsertContact(phone, { lastTs: Date.now(), ...patch });
    renderKanban();
  }
  function refreshCounters(){
    const all = Object.values(state.contacts);
    byId('mNovos').textContent = all.filter(c=> (c.stage||'novo')==='novo').length;
    byId('mQuali').textContent = all.filter(c=> c.stage==='qualificando').length;
    byId('mProp').textContent  = all.filter(c=> c.stage==='proposta').length;
    byId('mFech').textContent  = all.filter(c=> c.stage==='fechado').length;
  }

  // ===== WA backend =====
  async function waStatus(){
    try{
      const r = await fetch(window.PIXELUP.WA_BASE + '/status');
      const j = await r.json();
      waStatusText.textContent = 'Status: ' + (j.connected ? ('on' + (j.user ? ' ('+j.user+')' : '')) : 'off');
      return !!j.connected;
    }catch{ waStatusText.textContent = 'Status: off'; return false; }
  }
  async function waSend({to, text}){
    const r = await fetch(window.PIXELUP.WA_BASE + '/send', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to,text})});
    try{ return await r.json(); }catch{ return {ok:false}; }
  }
  function waEvents(){
    let es=null, timer=null;
    const url = (location.hostname.endsWith('vercel.app') ? window.PIXELUP.REPLIT_DIRECT : window.PIXELUP.WA_BASE) + '/events';
    const open = ()=>{
      try{
        if(es) es.close();
        es = new EventSource(url);
        es.onopen = ()=>{ /* ok */ };
        es.onmessage = async (ev)=>{
          try{
            const data = JSON.parse(ev.data);
            if(data.type==='status'){ await waStatus(); }
            if(data.type==='message'){
              const phone = norm(data.from||''); if(!phone) return;
              upsertContact(phone, {
                name: data.name||phone, origin: 'WhatsApp',
                lastText: data.text||'', lastTs: data.ts||Date.now()
              });
              pushMsg(phone, {who:'them', text:data.text||'', ts:data.ts||Date.now()});
              if(state.current===phone) renderThread(phone);
              if(state.botMap[phone]){ await botPreAtendimento(phone, data.text||''); }
              renderKanban();
            }
          }catch{}
        };
        es.onerror = ()=>{ timer && clearTimeout(timer); timer=setTimeout(open,3000); };
      }catch{ timer && clearTimeout(timer); timer=setTimeout(open,3000); }
    };
    open();
  }

  // ===== Gemini =====
  function getGeminiKey(){ return (state.aiKey||'').trim(); }
  async function geminiCall(prompt, json=false){
    const key = getGeminiKey(); if(!key) return json ? null : '';
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${window.PIXELUP.GEMINI_MODEL}:generateContent`;
    const body = json
      ? { contents:[{ parts:[ {text: prompt} ] }], generationConfig:{ response_mime_type:"application/json" } }
      : { contents:[{ parts:[ {text: prompt} ] }] };
    try{
      const r = await fetch(url, {method:'POST', headers:{'Content-Type':'application/json','x-goog-api-key': key}, body: JSON.stringify(body)});
      if(!r.ok) return json ? null : '';
      const j = await r.json();
      const text = j?.candidates?.[0]?.content?.parts?.[0]?.text || '';
      if(json){ try{ return JSON.parse(text); }catch{ return null; } }
      return text.trim();
    }catch{ return json ? null : ''; }
  }
  async function botPreAtendimento(phone, textIn){
    const extract = await geminiCall(
      `A partir da mensagem do cliente, extraia um JSON curto com campos (pode faltar):
       nome, email, necessidade, orcamento, prazo.
       Mensagem: "${textIn}"`, true);
    if(extract){
      const c = state.contacts[phone] || {phone};
      const notes = [
        extract.nome?`Nome: ${extract.nome}`:'',
        extract.email?`Email: ${extract.email}`:'',
        extract.necessidade?`Necessidade: ${extract.necessidade}`:'',
        extract.orcamento?`Orçamento: ${extract.orcamento}`:'',
        extract.prazo?`Prazo: ${extract.prazo}`:''
      ].filter(Boolean).join(' | ');
      state.contacts[phone] = {
        ...c,
        name: c.name || extract.nome || phone,
        email: c.email || extract.email || '',
        notes: notes || c.notes || '',
        lastText: textIn, lastTs: Date.now()
      };
      ls.set('px_contacts', state.contacts);
      renderKanban();
      if(state.current===phone) renderThread(phone);
    }
    const reply = await geminiCall(
      "Atue como atendente virtual da PixelUp. Peça educadamente os dados em falta (nome, e-mail, necessidade, orçamento, prazo). " +
      "Se o assunto for veículos, pergunte modelo/ano/valor. Se o cliente pedir humano, diga que vai acionar o atendimento.\n\n" +
      "Mensagem do cliente: " + textIn, false);
    if(reply){
      await waSend({to:phone, text: reply});
      pushMsg(phone, {who:'me', text: reply, ts: Date.now()});
      if(state.current===phone) renderThread(phone);
    }
  }

  // ===== Mentoria (ordem correta + auto-load .docx) =====
  const modulesSeed = [
    {id:'m1', title:'Módulo 1 — Persona e Fundamentos do Negócio'},
    {id:'m2', title:'Módulo 2 — Algoritmo do Meta'},
    {id:'m3', title:'Módulo 3 — Cronograma e Calendário Editorial'},
    {id:'m4', title:'Módulo 4 — Conteúdo Visual'},
    {id:'m5', title:'Módulo 5 — Copy com IA'},
    {id:'m6', title:'Módulo 6 — CRM e Organização Comercial'},
    {id:'m7', title:'Módulo 7 — Técnicas de Vendas'},
    {id:'m8', title:'Módulo 8 — Implementação de CRM + Tráfego Pago'}
  ];
  const modulesList = byId('modulesList'), lessonTitle = byId('lessonTitle'), lessonBody = byId('lessonBody');
  let currentModule = null;
  function modKey(id){ return 'px_mod_'+id; }
  function loadMod(id){ return ls.get(modKey(id), {html:'(sem conteúdo — importe o .docx deste módulo ou suba /mentoria/'+id.replace('m','m')+'.docx)'}) }
  function saveMod(id,html){ ls.set(modKey(id), {html}); }
  async function tryFetchDocx(id){
    try{
      const res = await fetch(`/mentoria/${id}.docx`, {cache:'no-store'});
      if(!res.ok) return false;
      const buf = await res.arrayBuffer();
      const html = (await window.mammoth.convertToHtml({arrayBuffer:buf})).value || '';
      if(html){ saveMod(id, html); return true; }
      return false;
    }catch{ return false; }
  }
  async function selectModule(m){
    currentModule = m.id;
    lessonTitle.textContent = m.title;
    // tenta carregar automático uma vez se não tiver conteúdo salvo
    const saved = loadMod(m.id);
    if(saved && saved.html && !/sem conteúdo/.test(saved.html)){
      lessonBody.innerHTML = saved.html;
    }else{
      const ok = await tryFetchDocx(m.id);
      const after = loadMod(m.id);
      lessonBody.innerHTML = ok ? after.html : saved.html;
    }
  }
  function renderModules(){
    modulesList.innerHTML = '';
    modulesSeed.forEach(m=>{
      const b = document.createElement('button');
      b.className = 'btn secondary'; b.style.margin='4px'; b.textContent = m.title;
      b.onclick = ()=> selectModule(m);
      modulesList.appendChild(b);
    });
  }
  renderModules();

  byId('importDocx').onclick = async ()=>{
    const f = byId('docxInput').files?.[0]; if(!f){ alert('Selecione um .docx'); return; }
    if(!currentModule){ alert('Escolha um módulo à esquerda antes de importar'); return; }
    try{
      const arrayBuffer = await f.arrayBuffer();
      const res = await window.mammoth.convertToHtml({arrayBuffer});
      saveMod(currentModule, res.value || '(vazio)');
      lessonBody.innerHTML = res.value || '(vazio)';
      alert('Conteúdo importado para '+currentModule);
    }catch(e){ alert('Falha ao ler .docx'); }
  };

  // ===== Configurações (nome do usuário) =====
  const userName = byId('userName'), saveUser = byId('saveUser');
  userName.value = state.userName || '';
  saveUser.onclick = ()=>{ state.userName = (userName.value||'').trim(); ls.set('px_user_name', state.userName); alert('Nome salvo!'); };

  // ===== Boot =====
  (function boot(){
    // iniciar SSE, status WA, e preparar conversa
    waEvents(); waStatus();
    renderKanban(); renderThread(null); refreshCounters();
  })();
  </script>

  <footer class="muted" style="text-align:center;padding:20px">© PixelUp — SuperApp Classic</footer>
</body>
</html>
