<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PixelUp SuperApp — WhatsApp</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#0e1013; --panel:#111827; --muted:#9aa4b2; --brand:#00b3ff; --brand-2:#18a1ff;
      --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; --card:#0b1520; --line:#102437;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:linear-gradient(rgba(8,12,18,.9), rgba(8,12,18,.9)), radial-gradient(1200px 600px at 80% -10%, rgba(0,179,255,.18), transparent 60%),
                 radial-gradient(900px 500px at -10% 120%, rgba(0,179,255,.12), transparent 60%), var(--bg);
      color:#eaf6ff; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .topbar{
      position:sticky; top:0; z-index:10; display:flex; gap:12px; align-items:center; padding:14px 18px;
      background:rgba(11,21,32,.75); border-bottom:1px solid var(--line); backdrop-filter:saturate(1.2) blur(6px);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700}
    .dot{width:12px; height:12px; border-radius:50%; background:linear-gradient(180deg,var(--brand),#3ddcff)}
    nav{margin-left:auto; display:flex; gap:8px; flex-wrap:wrap}
    nav a{color:#cfeaff; text-decoration:none; padding:6px 10px; border:1px solid transparent; border-radius:10px}
    nav a.active, nav a:hover{border-color:#174464; background:rgba(0,179,255,.08)}

    .container{max-width:980px; margin:24px auto; padding:0 16px}
    .card{
      background:linear-gradient(180deg, rgba(11,21,32,.85), rgba(8,12,18,.85));
      border:1px solid #0f2a40; border-radius:16px; padding:18px; box-shadow:0 10px 40px rgba(0,179,255,.05);
    }
    h1{font-size:24px; margin:4px 0 8px}
    .muted{color:var(--muted)}
    .row{display:flex; gap:14px; flex-wrap:wrap; align-items:center}
    .btn{
      appearance:none; border:none; cursor:pointer; padding:10px 14px; border-radius:12px; color:#06141f; font-weight:700;
      background:linear-gradient(180deg,#79d2ff,#27b0ff); box-shadow:0 4px 18px rgba(0,179,255,.3);
    }
    .btn.secondary{color:#dbeafe; background:transparent; border:1px solid #1b4663}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .badge{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; border:1px solid #123249; background:#09151f; color:#cfeaff;
      font-size:12px; font-weight:600;
    }
    .b-ok{border-color:#134e27; color:#b7ffd3; background:#0a1a12}
    .b-warn{border-color:#614214; color:#ffe9bd; background:#1b1407}
    .b-danger{border-color:#5b1b1b; color:#ffcccc; background:#1b0a0a}

    .grid{display:grid; grid-template-columns:1.2fr .8fr; gap:18px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr} }

    .panel{border:1px solid #13304a; border-radius:14px; padding:14px; background:#0a1621}
    label{font-size:12px; color:#9bb3c9}
    input[type="text"]{
      width:100%; padding:10px 12px; border-radius:10px; background:#0b1520; border:1px solid #183149; color:#dff1ff;
      outline:none;
    }
    .switch{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .switch > *{display:flex; gap:8px; align-items:center}
    .qrbox{
      display:grid; place-items:center; min-height:280px; border:1px dashed #1f415c; border-radius:16px; background:#08121a; overflow:hidden;
    }
    .qrimg{max-width:100%; height:auto; image-rendering:pixelated}
    .code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:12px; color:#bcd7f0}
    .log{max-height:180px; overflow:auto; background:#08131b; border:1px solid #15324a; border-radius:10px; padding:8px; font-size:12px}
    .hint{font-size:12px; color:#9fb8cc}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><span class="dot"></span> PixelUp SuperApp</div>
    <nav>
      <a href="#" class="active">WhatsApp</a>
      <a href="#crm">CRM</a>
      <a href="#mentoria">Mentoria</a>
      <a href="#chat">ChatBot</a>
    </nav>
  </header>

  <main class="container">
    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div>
          <div class="muted">APIs: WA <span class="code">/status • /start • /qr • /health</span></div>
          <h1>Conexão WhatsApp</h1>
        </div>
        <div id="statusBadge" class="badge b-warn">⏺ Desconectado</div>
      </div>

      <div class="grid" style="margin-top:10px">
        <section class="panel">
          <div class="row" style="margin-bottom:12px">
            <button id="btnConnect" class="btn">Conectar / Mostrar QR</button>
            <button id="btnStatus" class="btn secondary">Atualizar status</button>
            <button id="btnLogout" class="btn secondary" title="Encerrar sessão">Logout</button>
          </div>

          <div class="qrbox" id="qrBox">
            <div class="muted">Clique em <b>Conectar / Mostrar QR</b> e escaneie no WhatsApp → Aparelhos conectados.</div>
          </div>

          <p class="hint" style="margin:10px 2px 0">
            O QR é atualizado automaticamente até conectar. Depois de conectado, este painel mostra “Conectado”.
          </p>
        </section>

        <aside class="panel">
          <div class="switch" style="margin-bottom:10px">
            <label><input type="radio" name="mode" value="replit" checked> Replit direto</label>
            <label><input type="radio" name="mode" value="proxy"> Proxy /api/wa (Vercel)</label>
          </div>

          <label for="replitBase">Base do servidor (Replit)</label>
          <input id="replitBase" type="text" value="https://pixelup-wa-server.pixelupmrkt.repl.co" spellcheck="false"/>

          <div style="height:10px"></div>
          <label for="sessionId">Session ID</label>
          <input id="sessionId" type="text" value="pixelup" />

          <div style="height:14px"></div>
          <div class="code">Exemplos:
            <div>GET <span id="exStatus">…/status?session=pixelup</span></div>
            <div>POST <span id="exStart">…/start?session=pixelup</span></div>
            <div>GET <span id="exQr">…/qr?session=pixelup</span></div>
          </div>

          <div style="height:14px"></div>
          <div class="log" id="log"></div>
        </aside>
      </div>
    </div>
  </main>

  <script>
    // --------- CONFIG ---------
    const CONFIG = {
      // Modo "proxy" usa o mesmo domínio do app: /api/wa
      PROXY_BASE: "/api/wa",
      // Modo "replit" vem da caixa de texto (pré-preenchida com o seu projeto)
    };

    // --------- HELPERS UI ---------
    const $ = sel => document.querySelector(sel);
    const logEl = $("#log");
    function log(msg, type="info"){
      const t = new Date().toLocaleTimeString();
      const line = document.createElement("div");
      line.textContent = `[${t}] ${msg}`;
      if(type==="err") line.style.color = "#ffb0b0";
      if(type==="ok")  line.style.color = "#b9ffd5";
      logEl.prepend(line);
    }
    function badge(state){
      const el = $("#statusBadge");
      el.className = "badge";
      if(state==="connected"){ el.classList.add("b-ok"); el.textContent = "✅ Conectado"; }
      else if(state==="connecting"){ el.classList.add("b-warn"); el.textContent = "⏳ Conectando…"; }
      else if(state==="error"){ el.classList.add("b-danger"); el.textContent = "⚠️ Erro"; }
      else { el.classList.add("b-warn"); el.textContent = "⏺ Desconectado"; }
    }
    function setQR(imgBlobOrDataUrl){
      const box = $("#qrBox");
      box.innerHTML = "";
      const img = document.createElement("img");
      img.className = "qrimg";
      if(typeof imgBlobOrDataUrl === "string") img.src = imgBlobOrDataUrl;
      else img.src = URL.createObjectURL(imgBlobOrDataUrl);
      box.appendChild(img);
    }
    function setQRPlaceholder(){
      $("#qrBox").innerHTML = '<div class="muted">Aguardando QR…</div>';
    }

    // --------- BUILD BASE URL ---------
    function getMode(){ return document.querySelector('input[name="mode"]:checked').value; }
    function getBase(){
      const session = $("#sessionId").value.trim() || "pixelup";
      let base = "";
      if(getMode()==="proxy"){ base = CONFIG.PROXY_BASE; }
      else {
        base = ($("#replitBase").value || "").trim().replace(/\/+$/,"");
        if(!/^https?:\/\//i.test(base)) base = "https://" + base;
      }
      // Preenche exemplos
      $("#exStatus").textContent = `${base}/status?session=${session}`;
      $("#exStart").textContent  = `${base}/start?session=${session}`;
      $("#exQr").textContent     = `${base}/qr?session=${session}`;
      return { base, session };
    }

    // --------- HTTP WRAPPER ---------
    async function apiGet(path){
      const {base} = getBase();
      const url = `${base}${path}`;
      const res = await fetch(url, {method:"GET"});
      return {res, url};
    }
    async function apiPost(path, body){
      const {base} = getBase();
      const url = `${base}${path}`;
      const res = await fetch(url, {method:"POST", headers:{'Content-Type':'application/json'}, body: body? JSON.stringify(body): null});
      return {res, url};
    }

    // --------- ACTIONS ---------
    let qrTimer = null, statusTimer = null;

    async function refreshStatus(){
      try{
        const {session} = getBase();
        const {res, url} = await apiGet(`/status?session=${encodeURIComponent(session)}`);
        const ct = res.headers.get("content-type") || "";
        let data = null;
        if(ct.includes("application/json")) data = await res.json();
        log(`GET ${url} → ${res.status}`);
        if(!res.ok){ badge("error"); return; }
        const connected = data && (data.connected || data.status==="CONNECTED" || data.state==="CONNECTED");
        badge(connected? "connected":"");
        return connected;
      }catch(e){
        log("Status falhou: "+e.message, "err");
        badge("error");
        return false;
      }
    }

    async function startSessionAndShowQR(){
      const {session} = getBase();
      badge("connecting");
      $("#btnConnect").disabled = true;
      try{
        // 1) start
        const {res, url} = await apiPost(`/start?session=${encodeURIComponent(session)}`);
        log(`POST ${url} → ${res.status}`);
      }catch(e){
        log("Start falhou: "+e.message, "err");
      }

      // 2) puxar QR em loop até conectar
      setQRPlaceholder();
      clearInterval(qrTimer); clearInterval(statusTimer);

      qrTimer = setInterval(fetchQROnce, 3500);
      statusTimer = setInterval(async ()=>{
        const ok = await refreshStatus();
        if(ok){
          clearInterval(qrTimer);
          clearInterval(statusTimer);
          $("#btnConnect").disabled = false;
          $("#qrBox").innerHTML = '<div class="muted">✅ Dispositivo conectado.</div>';
        }
      }, 3500);

      // dispara primeiro fetch sem esperar o intervalo
      fetchQROnce().finally(()=>{ $("#btnConnect").disabled = false; });
    }

    async function fetchQROnce(){
      try{
        const {session} = getBase();
        const {res, url} = await apiGet(`/qr?session=${encodeURIComponent(session)}`);
        log(`GET ${url} → ${res.status}`);
        if(!res.ok){
          // Alguns servidores retornam 204 quando já está conectado
          if(res.status===204){ $("#qrBox").innerHTML = '<div class="muted">Sem QR (possivelmente já conectado).</div>'; return; }
          throw new Error("QR não disponível");
        }
        const ct = res.headers.get("content-type") || "";
        if(ct.includes("application/json")){
          const j = await res.json();
          if(j.qr){ setQR(j.qr.startsWith("data:")? j.qr : `data:image/png;base64,${j.qr}`); }
          else if(j.image){ setQR(j.image); }
          else { $("#qrBox").innerHTML = '<div class="muted">QR recebido (JSON), mas sem imagem.</div>'; }
        }else{
          const blob = await res.blob();
          setQR(blob);
        }
      }catch(e){
        $("#qrBox").innerHTML = `<div class="muted">Não foi possível obter o QR agora. Tente novamente.</div>`;
        log("QR erro: "+e.message, "err");
      }
    }

    async function doLogout(){
      try{
        const {session} = getBase();
        const {res, url} = await apiPost(`/logout?session=${encodeURIComponent(session)}`);
        log(`POST ${url} → ${res.status}`);
        badge("");
        $("#qrBox").innerHTML = '<div class="muted">Sessão finalizada. Clique em Conectar para gerar novo QR.</div>';
      }catch(e){
        log("Logout falhou: "+e.message, "err");
      }
    }

    // --------- EVENTS ---------
    $("#btnConnect").addEventListener("click", startSessionAndShowQR);
    $("#btnStatus").addEventListener("click", refreshStatus);
    $("#btnLogout").addEventListener("click", doLogout);
    document.querySelectorAll('input[name="mode"]').forEach(r=>{
      r.addEventListener("change", ()=>{ getBase(); });
    });
    $("#replitBase").addEventListener("change", ()=> getBase());
    $("#sessionId").addEventListener("change", ()=> getBase());

    // Inicializa exemplos de rotas
    getBase();

    // Primeira checagem de status ao abrir
    refreshStatus();
  </script>
</body>
</html>
